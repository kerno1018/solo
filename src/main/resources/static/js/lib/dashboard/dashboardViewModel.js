define(["jquery","knockout","underscore","gridstack","./dashboard","./Widget","ko-binding-utils","text!./dashboardTemplate.html","dialog-utils","acs-resource","version","user-validation","alert-utils","datatables-knockout"],function(e,t,a,o,r,d,i,s,n,c,l,h,u){"use strict";var g=function(e){return g=e,e.NUMBER_COLUMNS=4,e.ROW_HEIGHT=200,e.maxDashboardSize=4,e.GENERIC_ERROR_MSG="There was an issue communicating with the server. Please try again later.",e.DASHBOARD_CONTAINER_ID="#ss-container-dashboard-",e.WIDGET_JSON_URL="widgetTestData.json",e.DEFAULT_WIDGETS_JSON_URL="DefaultWidgets.json",e.DEFAULT_DASHBOARD_NAME="Dashboard",e.gridStackOptions={cell_height:g.ROW_HEIGHT,vertical_margin:15,animate:!0,width:g.NUMBER_COLUMNS,handle:".sDashboardWidgetHeader"},e.resource=new c({url:"dashboards"}),e.widgetResource=new c({url:"widgetMetaData"}),g}({}),b=function(i){var s=this;s.options=a.extend({},g,i),s.fixed=s.options.fixed||!1,s.options.gridStackOptions.static_grid=s.fixed,s.number_columns=s.options.NUMBER_COLUMNS,s.dashboardCounter=t.observable(0),s.maxDashboardSize=s.options.maxDashboardSize,s.selectedDashboard=t.observable(),s.lastDashboardId=t.observable(-1),s.dashboards=t.observableArray([]),s.widgetsLoaded=t.observable(!1),s.userDashboardData={},s.createTitle=t.observable(""),e("#addDashboardContainer").on("hide.bs.dropdown",function(){s.createTitle("")}),s._generateGuid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},s._gridStack=function(t){t&&null===t.grid&&(t.grid=e(s.options.DASHBOARD_CONTAINER_ID+t.id).gridstack(s.options.gridStackOptions).data("gridstack"),t.grid.remove_all())},s._registerEvent=function(a){var o=this,r=e(o.options.DASHBOARD_CONTAINER_ID+a.id);r.on("change",function(d,i){var s=o.userDashboardData[a.id],n=s.readOnly?s.readOnly:!1;r.children().each(function(){var a=e(this),o=a.data("_gridstack_node"),r=a.attr("id").split("WIDGET-")[1];t.utils.arrayForEach(s.widgets,function(e){e.id===r&&(e.xPos=o.x,e.yPos=o.y)})}),n||o.options.resource.update(s).done(function(){})}),r.on("removeWidget",function(e,t){var d="#WIDGET-"+t.id;null===a.grid&&(a.grid=r.gridstack(o.options.gridStackOptions).data("gridstack")),a.grid.remove_widget(d)})},s._loadWidgets=function(a){var o=this;e.getJSON(o.options.WIDGET_JSON_URL,function(r){o.widgetsMetadata={},o.filteredWidgets=[],e.each(r,function(e,t){o.widgetsMetadata[t.id]=new d(t)}),e.map(o.widgetsMetadata,function(e){var t=!1;if(e.disabledForAdd)t=!1;else if(e.service||e.category){if(e.service)for(var a=e.service.split(","),r=0;r<a.length;r++)h.hasService(a[r])&&(t=!0);!t&&e.category&&h.hasServiceCategory(e.category)&&(t=!0)}else t=!0;!t||e.privilege&&!h.hasPrivilege(e.privilege)||o.filteredWidgets.push(e)}),o.widgetDataTable={data:t.computed(function(){var a=e.map(o.filteredWidgets,function(e,t){return[e]}),r=t.utils.arrayMap(a,function(e){return{checkbox:t.observable(!1),widgetObj:e,actions:""}});return r}),options:{searching:!0,inProgress:!1,pageLength:5,lengthMenu:[5,10,25,50,100],settings:!1,advancedSearch:!1,selectOptions:{selectionMode:"single",selectAction:"addSelectedWidget"}}},o.widgetsLoaded(!0),a()},function(e,t,a){u.showErrorAlert(o.options.GENERIC_ERROR_MSG),console.log("Error Occuured while Loading the Widget Metadata, Error - "+e.responseText)})},s._getDashboard=function(t){var a=this;e.isEmptyObject(a.widgetsMetadata)||a.options.resource.get().done(function(e){e&&e.length&&e.length>0?a._initDashboard(e):(console.log("No dashboard created yet for user, creating default one"),a._getDefaultDashboard())}).fail(function(e,t,a){console.log("Error Occuured while Fetching the User Dashborad Data, Error - "+e.responseText)})},s._initDashboard=function(a){var i=this;e.each(a,function(e,t){i.userDashboardData[t.id]=t}),i.dashboards(t.utils.arrayMap(a,function(a,s){var n=[];return n=t.utils.arrayMap(a.widgets,function(t){return new d(e.extend({},i.widgetsMetadata[t.refId],t))}),n=o.Utils.sort(n),new r(a,0===s,n,i.fixed)})),i.dashboardCounter(i.dashboards().length),i.selectedDashboard(i.dashboards()[0]),i.dashboardCounter()>0&&i.lastDashboardId(i.dashboards()[i.dashboardCounter()-1].id)},s._getDefaultDashboard=function(){var t=this;e.getJSON(t.options.DEFAULT_WIDGETS_JSON_URL,function(e){for(var a=t.options.DEFAULT_DASHBOARD_NAME,o=[],r=0;r<e.length;r++)for(var d=0;d<t.filteredWidgets.length;d++)if(t.filteredWidgets[d].id==e[r].refId){o.push(e[r]);break}t.options.resource.add({name:a,widgets:o}).done(function(){t._getDashboard()}).fail(function(e,a,o){u.showErrorAlert(t.options.GENERIC_ERROR_MSG)})},function(e){u.showErrorAlert(t.options.GENERIC_ERROR_MSG),console.log("Error Occuured while saving the default dashboard, Error - "+e)})},s._filterDashboard=function(e,a){return t.utils.arrayFilter(a,function(t){return t.id===e})[0]},s._loadWidgets(function(){s.fixed?s._initDashboard([s.options.dashboardData]):s._getDashboard(i)}),s.afterAddWidget=function(t,o){var r=this,d=a.find(t,function(e){return 1===e.nodeType});null===r.grid&&(r.grid=e(d.parentElement).gridstack(s.options.gridStackOptions).data("gridstack"),r.grid.remove_all()),-1===o.x||-1===o.yPos?r.grid.add_widget(d,o.x,o.y,o.width,o.height,!0):r.grid.add_widget(d,o.x,o.y,o.width,o.height,!1)}};return b.prototype.myPostProcessingLogic=function(e,t){this._registerEvent.call(this,t)},b.prototype.selectDashboard=function(t,a,o){var r,d=this,i=t.selectedDashboard();o=o||window.event,r=e(o.target||o.srcElement),r.is(".tabIcon")||r.is(".fa-cog")?e("#dropdown_"+d.id).dropdown("toggle"):i.id!==d.id&&(i.selected(!1),d.selected(!0),t.selectedDashboard(d),d.widgetsInitialized()||d.widgetsInitialized(!0))},b.prototype.addDashboard=function(){var t,a=this,o=a.createTitle();a.dashboardCounter()<a.maxDashboardSize&&o&&""!==o&&a.options.resource.add({name:o,widgets:[]}).done(function(o){o&&(a.userDashboardData[o.id]=o,a.selectedDashboard()&&a.selectedDashboard().selected(!1),t=new r(o,!0,[]),a.dashboards.push(t),a.selectedDashboard(t),a.dashboardCounter(a.dashboards().length),a.lastDashboardId(o.id),a._gridStack(t),a.createTitle(""),e("#addDashboardBtn").dropdown("toggle"))}).fail(function(e,t,o){u.showErrorAlert(a.options.GENERIC_ERROR_MSG),console.log("Error Occuured while Adding the dashboard Tab on the page, Error - "+e.responseText)})},b.prototype.showRemoveModal=function(){var t=this,a=t.data,o=t.dashboardViewModel,r=t.index();e("#dropdown_"+a.id).dropdown("toggle"),n.showModalDialog("warning","Are you sure you want to remove "+a.name()+" from your dashboards?","Cancel","Continue",function(){o.options.resource.remove({id:a.id}).done(function(){a.id in o.userDashboardData&&delete o.userDashboardData[a.id],o.dashboards.remove(a),o.dashboardCounter(o.dashboards().length),o.selectedDashboard().id===a.id&&(1===o.dashboardCounter()?o.selectDashboard.call(o.dashboards()[r-1],o):o.dashboardCounter()>1&&(a.id===o.lastDashboardId()?o.selectDashboard.call(o.dashboards()[r-1],o):o.selectDashboard.call(o.dashboards()[r+1],o)))}).fail(function(e,a,o){u.showErrorAlert(t.options.GENERIC_ERROR_MSG),console.log("Error Occuured while removing the dashboard tab from the page, Error - "+e.responseText)})},function(){},"warning")},b.prototype.addSelectedWidget=function(){var t=this.$data,a=this.widgetObj,o=t.selectedDashboard().id;if(a){var r={id:t._generateGuid(),refId:a.id,name:a.name,description:a.description,settings:{},xPos:-1,yPos:-1};o in t.userDashboardData&&t.userDashboardData[o].widgets.push(r),t.options.resource.update(t.userDashboardData[o]).done(function(){var i=t._filterDashboard(o,t.dashboards()),s=new d(e.extend(!0,{},a,r));i.widgets.push(s),e("#addWidgetBtn").dropdown("toggle")}).fail(function(e,a,o){u.showErrorAlert(t.options.GENERIC_ERROR_MSG),console.log("Error occuured while Adding the widgets to selected dashboard, Error - "+e.responseText)})}},b.prototype.renameDashboardTitle=function(){var t,a=this.dashboardViewModel,o=this.data,d=this.title,i=!1;o instanceof r&&(t=a.userDashboardData[o.id],d&&""!==d&&t.name!==d&&(t.name=d,i=!0)),i?a.options.resource.update(t).done(function(){e("#dropdown_"+o.id).dropdown("toggle"),o.name(d)}):e("#dropdown_"+o.id).dropdown("toggle")},{viewModel:b,template:s}});
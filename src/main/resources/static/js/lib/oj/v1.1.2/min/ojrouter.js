/**
 * Copyright (c) 2014, 2015, Oracle and/or its affiliates.
 * All rights reserved.
 */
"use strict";
define(["ojs/ojcore","knockout","signals","promise"],function(a,f,d){(function(){function b(b){a.u.info("Entering _updateAll.");for(var c=!1,d=0;d<b.length&&(c=b[d],c=c.Rc.Qj(c.value),c);d++);a.u.info("_updateAll returns "+(c?"true":"false"));return{hasChanged:c}}function c(b){a.u.info("Start _canEnter.");for(var c=!0,d=Promise.resolve(!0),e=[],g=0;g<b.length;g++){var f=b[g],h=f.Rc.xh(f.value);if(h&&(f=h.canEnter,"function"===typeof f)){var p;try{p=f()}catch(k){return a.u.error("Error when executing canEnter callback: "+
k.message),Promise.resolve([])}if(p&&p.then)d=p;else if(c=p,!c){a.u.info("canEnter is false for state: "+h.id);break}}e.push(d)}return c?Promise.all(e).then(function(c){for(var d=0;d<c.length;d++)if(!c[d])return a.u.info("CanEnter promise at position "+d+" returned false."),[];return b}):Promise.resolve([])}function e(a){return a.substring(0,a.lastIndexOf("/"))}function g(a){var b={};if(a){var c=[],c=a.split("\x26"),d;for(d in c){var e=c[d].split(/=(.+)?/);a=e[0];a.length&&("undefined"===typeof b[a]&&
(b[a]=[]),e=e[1]&&decodeURIComponent(e[1].replace(/\+/g," ")),b[a].push(e))}}return b}function h(){var a;window.location.hash&&0<window.location.hash.length?(a=window.location.hash.replace(/[^#]*#/,""),a=a.replace(x+"/","")):a=window.location.href.replace(v+"/","");return a}function k(a){return a.parent?k(a.parent)+"."+a.name:a.name}function l(a,b){for(var c,d=0;d<a.sg.length;d++){var e=a.sg[d].Rc;if(!e.Uo||e.Uo===b){c=e;break}}return c}function m(a,b){if(b&&0<Object.getOwnPropertyNames(b).length){var c;
c=-1==a.indexOf("?")?"?":"\x26";var d=a,e=JSON.stringify(b),g=encodeURIComponent(e),e=z.ofa(e),f=!1,h="oj_Router\x3d";e.length<=g.length&&(f=!0);h=f?h+("1"+e):h+("0"+g);if(1024<h.length)throw Error("Size of bookmarkable data is too big.");a=d+(c+h)}return a}function n(){a.u.info("Handling popState event with URL: "+window.location.href);for(var b=null,c=0;c<D.sg.length;c++){var d=D.sg[c].Rc;if(D.hf()&&D.hf()===d.Uo){b=d;break}}s(b).then(function(a){if(a)return t(h()).then(function(a){q(a.hasChanged)});
q(!1);return Promise.resolve({hasChanged:!1})}).then(null,function(b){a.u.error("Error while changing state in handlePopState: "+b.message)})}function q(b){a.nb.transitionedToState.dispatch({hasChanged:b})}function p(a,b,c){var d=[];a.parent&&(d=p(a.parent,b+1));var e;"undefined"===typeof c?(c=a.TP())&&(e=c.id):e=c.id;e===a.Bj&&0===b&&(e=null);d.push({Rc:a,aC:e});return d}function r(b,c){var d=!0,e=Promise.resolve(!0),g=b.xh(b.hf());if(g){for(var f=0;f<b.sg.length;f++)if(d=r(b.sg[f].Rc,c),!d)return!1;
f=g.fC&&g.fC.canExit?g.fC.canExit:g.canExit;if("function"===typeof f){var h;try{h=f()}catch(p){return a.u.error("Error when executing canExit callback: "+p.message),!1}h&&h.then?e=h:(h||a.u.info("canExit is false for state "+g.id),d=h)}}c.push(e);return d}function s(b){if(!b)return Promise.resolve(!0);var c=[];return(b=r(b,c))?Promise.all(c).then(function(b){for(var c=0;c<b.length;c++)if(!b[c])return a.u.info("CanExit promise at position "+c+" returned false."),!1;return!0}):Promise.resolve(b)}function t(d){var e;
try{var g=d;d={};var f=g.split("?")[1]||"";a.u.info("Parsing: "+g);var g=w.aw(g),h=f.split("oj_Router\x3d")[1];if(h){var f=h=h.split("\x26")[0],p=f.charAt(0),f=f.slice(1);if("0"===p)f=decodeURIComponent(f);else if("1"===p)f=z.Efa(f);else throw Error("Error retrieving bookmarkable data. Format is invalid");d=JSON.parse(f)}if(a.u.option("level")===a.u.bx){a.u.info("Bookmarkable data: ");for(var l in d)a.u.info("   { router: "+l+", value: "+d[l])}l=[];p=[];l=w.parse(g);for(g=0;g<l.length;g++){var r=
l[g],m=d[r.Rc.name];m&&(r.Rc.Fi=m);r.value!==r.Rc.hf()&&p.push(r)}if(a.u.option("level")===a.u.bx)for(a.u.info("Potential changes are: "),r=0;r<p.length;r++)a.u.info("   { router: "+k(p[r].Rc)+", value: "+p[r].value+"}");e=p}catch(s){return Promise.reject(s)}return c(e).then(b)}var v,x,u=function(){var a="",b=window.location.pathname;-1!==b.indexOf(".html",b.length-5)&&(a=b.split("/").pop());return a}(),w,z={Z6:String.fromCharCode,JT:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",
w7:function(a,b){var c;z.Ot||(z.Ot={});if(!z.Ot[a])for(z.Ot[a]={},c=0;c<a.length;c++)z.Ot[a][a[c]]=c;return z.Ot[a][b]},ofa:function(a){return null==a?"":z.q5(a,6,function(a){return z.JT.charAt(a)})},Efa:function(a){return null==a?"":""==a?null:z.s6(a.length,32,function(b){return z.w7(z.JT,a.charAt(b))})},q5:function(a,b,c){if(null==a)return"";var d,e,g={},f={},h="",p="",k="",l=2,r=3,m=2,s="",n=0,t=0,q;for(q=0;q<a.length;q+=1)if(h=a[q],Object.prototype.hasOwnProperty.call(g,h)||(g[h]=r++,f[h]=!0),
p=k+h,Object.prototype.hasOwnProperty.call(g,p))k=p;else{if(Object.prototype.hasOwnProperty.call(f,k)){if(256>k.charCodeAt(0)){for(d=0;d<m;d++)n<<=1,t==b-1?(t=0,s+=c(n),n=0):t++;e=k.charCodeAt(0);for(d=0;8>d;d++)n=n<<1|e&1,t==b-1?(t=0,s+=c(n),n=0):t++,e>>=1}else{e=1;for(d=0;d<m;d++)n=n<<1|e,t==b-1?(t=0,s+=c(n),n=0):t++,e=0;e=k.charCodeAt(0);for(d=0;16>d;d++)n=n<<1|e&1,t==b-1?(t=0,s+=c(n),n=0):t++,e>>=1}l--;0==l&&(l=Math.pow(2,m),m++);delete f[k]}else for(e=g[k],d=0;d<m;d++)n=n<<1|e&1,t==b-1?(t=0,
s+=c(n),n=0):t++,e>>=1;l--;0==l&&(l=Math.pow(2,m),m++);g[p]=r++;k=String(h)}if(""!==k){if(Object.prototype.hasOwnProperty.call(f,k)){if(256>k.charCodeAt(0)){for(d=0;d<m;d++)n<<=1,t==b-1?(t=0,s+=c(n),n=0):t++;e=k.charCodeAt(0);for(d=0;8>d;d++)n=n<<1|e&1,t==b-1?(t=0,s+=c(n),n=0):t++,e>>=1}else{e=1;for(d=0;d<m;d++)n=n<<1|e,t==b-1?(t=0,s+=c(n),n=0):t++,e=0;e=k.charCodeAt(0);for(d=0;16>d;d++)n=n<<1|e&1,t==b-1?(t=0,s+=c(n),n=0):t++,e>>=1}l--;0==l&&(l=Math.pow(2,m),m++);delete f[k]}else for(e=g[k],d=0;d<
m;d++)n=n<<1|e&1,t==b-1?(t=0,s+=c(n),n=0):t++,e>>=1;l--;0==l&&m++}e=2;for(d=0;d<m;d++)n=n<<1|e&1,t==b-1?(t=0,s+=c(n),n=0):t++,e>>=1;for(;;)if(n<<=1,t==b-1){s+=c(n);break}else t++;return s},s6:function(a,b,c){for(var d=[],e=4,g=4,f=3,h="",p="",k,l,r,m,s,n=z.Z6,t={val:c(0),position:b,index:1},p=0;3>p;p+=1)d[p]=p;h=0;r=Math.pow(2,2);for(m=1;m!=r;)l=t.val&t.position,t.position>>=1,0==t.position&&(t.position=b,t.val=c(t.index++)),h|=(0<l?1:0)*m,m<<=1;switch(h){case 0:h=0;r=Math.pow(2,8);for(m=1;m!=r;)l=
t.val&t.position,t.position>>=1,0==t.position&&(t.position=b,t.val=c(t.index++)),h|=(0<l?1:0)*m,m<<=1;s=n(h);break;case 1:h=0;r=Math.pow(2,16);for(m=1;m!=r;)l=t.val&t.position,t.position>>=1,0==t.position&&(t.position=b,t.val=c(t.index++)),h|=(0<l?1:0)*m,m<<=1;s=n(h);break;case 2:return""}for(k=p=d[3]=s;;){if(t.index>a)return"";h=0;r=Math.pow(2,f);for(m=1;m!=r;)l=t.val&t.position,t.position>>=1,0==t.position&&(t.position=b,t.val=c(t.index++)),h|=(0<l?1:0)*m,m<<=1;switch(s=h){case 0:h=0;r=Math.pow(2,
8);for(m=1;m!=r;)l=t.val&t.position,t.position>>=1,0==t.position&&(t.position=b,t.val=c(t.index++)),h|=(0<l?1:0)*m,m<<=1;d[g++]=n(h);s=g-1;e--;break;case 1:h=0;r=Math.pow(2,16);for(m=1;m!=r;)l=t.val&t.position,t.position>>=1,0==t.position&&(t.position=b,t.val=c(t.index++)),h|=(0<l?1:0)*m,m<<=1;d[g++]=n(h);s=g-1;e--;break;case 2:return p}0==e&&(e=Math.pow(2,f),f++);if(d[s])h=d[s];else if(s===g)h=k+k[0];else return null;p+=h;d[g++]=k+h[0];e--;k=h;0==e&&(e=Math.pow(2,f),f++)}}};a.nb=function(a,b){var c=
this;this.Uo=b?b.hf():void 0;this.sg=[];this.Fi=void 0;this.hf=f.observable();this.Vm=null;this.Bj=void 0;this.TP=f.pureComputed(function(){return f.ignoreDependencies(c.xh,c,[c.hf()])});this.q6=f.pureComputed(function(){var a,b=f.ignoreDependencies(c.xh,c,[c.hf()]);b&&(a=b.value);return a});this.aba=Object.create(null,{name:{value:f.pureComputed(function(){var a,b=this.xh(this.hf());b&&((a=b.value)&&"string"===typeof a||(a=b.id));return a},c)},params:{value:c},lifecycleListener:{value:Object.create(null,
{attached:{value:function(a){var b=a.valueAccessor().params.currentState();b&&(b.fC=a.viewModel)}}})}});Object.defineProperties(this,{parent:{value:b,enumerable:!0},name:{value:a,enumerable:!0}})};o_("Router",a.nb,a);Object.defineProperties(a.nb.prototype,{states:{get:function(){return this.Vm},enumerable:!0},stateId:{get:function(){return this.hf},enumerable:!0},currentState:{get:function(){return this.TP},enumerable:!0},currentValue:{get:function(){return this.q6},enumerable:!0},defaultStateId:{get:function(){return this.Bj},
set:function(a){this.Bj=a},enumerable:!0},moduleConfig:{get:function(){return this.aba},enumerable:!0}});a.nb.prototype.KX=function(b){a.j.il(b);b=b.replace(a.Ba.JD,"");for(var c=0;c<this.sg.length;c++){var d=this.sg[c].Rc;if(d.name===b)throw Error('Invalid router name "'+b+'", it already exists.');if(d.Uo===this.hf())throw Error('Cannot create more than one child router for parent state id "'+d.Uo+'".');}c=new a.nb(b,this);this.sg.push({name:b,Rc:c});return c};a.b.i("Router.prototype.createChildRouter",
{KX:a.nb.prototype.KX});a.nb.prototype.xh=function(b){var c;if(b&&this.Vm){a.j.il(b);for(var d=0;d<this.Vm.length;d++){var e=this.Vm[d];if(e.id===b){c=e;break}}}return c};a.nb.prototype.Qj=function(b){var c=!1;b&&!this.xh(b)?a.u.error('State id: "'+b+'" is not a valid state for '+k(this)):(a.u.info("Updating state of "+k(this)+" to "+b),(c=this.xh(this.hf()))&&(c=c.exit)&&c.call(this),this.hf(b),c=!0,b&&(b=this.xh(b))&&(b=b.enter)&&b.call(this));return c};a.nb.prototype.GX=function(b){this.hf(void 0);
delete this.Bj;"function"===typeof b?(this.Vm=null,this.xh=b):(this.Vm=[],delete this.xh,Object.keys(b).forEach(function(c){var d=b[c];this.Vm.push(new a.Wp(c,d,this));"boolean"===typeof d.isDefault&&d.isDefault&&(this.Bj=c)},this));return this};a.b.i("Router.prototype.configure",{GX:a.nb.prototype.GX});a.nb.prototype.NY=function(a){return this.xh(a)};a.b.i("Router.prototype.getState",{NY:a.nb.prototype.NY});a.nb.prototype.go=function(b){function c(b){if(b)return t(g.replace(/^\//,"")).then(function(b){if(b.hasChanged){var c=
v+g;a.u.info("Changing URL to "+c);history.pushState(null,"",c)}q(b.hasChanged);return b});q(!1);return Promise.resolve({hasChanged:!1})}var d,e=!0;if(b)if("string"===typeof b){if(0<b.length){d=this.xh(b);if(!d)return q(!1),Promise.reject(Error('State id "'+b+'" does not exist.'));e=!1;a.u.info("Going to state "+b+" on router "+k(this))}}else return q(!1),Promise.reject(Error("Invalid object type for state id."));if(e)if(this.Bj)d=this.xh(this.Bj),a.u.info("Going to default state "+d.id+" on router "+
k(this));else return a.u.info("Undefined state id with no default id on router "+k(this)),q(!1),Promise.resolve({hasChanged:!1});b=p(this,0,d);var g=w.AX(b);b="/"+w.aw(h()).replace(u,"");if(w.aw(g)!==b)return a.u.info("New URL is different."),s(this).then(c);q(!1);return Promise.resolve({hasChanged:!1})};a.b.i("Router.prototype.go",{go:a.nb.prototype.go});a.nb.prototype.G_=function(a){this.Fi=a;a={};for(var b=this;b;)b.Fi&&(a[b.name]=b.Fi),b=b.parent;for(var b=this,c;b;){for(var d=0;d<b.sg.length;d++){var e=
b.sg[d].Rc;if(b.hf()&&b.hf()===e.Uo){e.Fi&&(a[e.name]=e.Fi);c=e;break}}b=c;c=void 0}c=v+"/"+w.aw(h());c=m(c,a);history.replaceState(null,"",c)};a.b.i("Router.prototype.store",{G_:a.nb.prototype.G_});a.nb.prototype.n_=function(){return this.Fi};a.b.i("Router.prototype.retrieve",{n_:a.nb.prototype.n_});a.nb.prototype.bw=function(){for(;0<this.sg.length;)this.sg[0].Rc.bw();if(this.parent){for(var b=this.parent.sg,c=0;c<b.length;c++)if(b[c].Rc.name===this.name){b.splice(c,1);break}delete this.Uo}else x=
v="",w={},window.removeEventListener("popstate",n),a.nb.transitionedToState.removeAll(),a.nb.BB=!1;this.Vm=null;delete this.Bj;delete this.Fi};a.b.i("Router.prototype.dispose",{bw:a.nb.prototype.bw});var D=new a.nb("root",void 0);Object.defineProperties(a.nb,{rootInstance:{value:D,enumerable:!0},transitionedToState:{value:new d.Signal,enumerable:!0}});a.nb.ac={};o_("Router.defaults",a.nb.ac,a);Object.defineProperties(a.nb.ac,{urlAdapter:{get:function(){w||(w=new a.nb.rL);return w},set:function(b){if(a.nb.BB)throw Error("Incorrect operation. Cannot change URL adapter after calling sync().");
w=b},enumerable:!0,cha:!1},baseUrl:{get:function(){v||(v=e(window.location.href.split("#")[0]),x=e(window.location.pathname));return v},set:function(b){if(a.nb.BB)throw Error("Incorrect operation. Cannot change base URL after calling sync().");v=b.replace(/\/$/,"");x=v.replace(window.location.protocol+"//"+window.location.host,"")},enumerable:!0,cha:!1}});a.nb.kL=function(){a.nb.BB||(w||(w=new a.nb.rL),v||(v=e(window.location.href.split("#")[0]),x=e(window.location.pathname)),window.addEventListener("popstate",
n,!1),a.u.info("Initializing rootInstance."),a.u.info("Base URL is "+v),a.u.info("This page is "+u),a.u.info("Current URL is "+window.location.href),a.nb.BB=!0);return t(h()).then(function(a){q(a.hasChanged);return a})};o_("Router.sync",a.nb.kL,a);a.nb.rL=function(){this.parse=function(a){var b=0,c=D;a=a.split("/");var d=[];do{var e=a[b++];e&&(0===e.length||/\.html$/i.test(e))&&(e=void 0);e=e||c.Bj;d.push({value:e,Rc:c});c=l(c,e)}while(c);return d};this.AX=function(b){var c="",d={};b.forEach(function(a){a.aC&&
(c+="/"+a.aC);a.Rc.Ria&&(d[a.Rc.name]=a.Rc.Fi)});""===c&&(c="/"+u);try{c=m(c,d)}catch(e){a.u.error("Error while building URL: "+e)}return c};this.aw=function(a){return a.split("?")[0]};this.GY=function(a){var b=a.indexOf("?"),c=null;-1!=b&&(c=a.substr(b+1));return g(c)}};o_("Router.urlPathAdapter",a.nb.rL,a);a.nb.Oha=function(){this.parse=function(a){a=this.GY(a);var b=D,c=[];do{var d=a[b.name];d&&(d=d[0],delete a[b.name]);d=d||b.Bj;c.push({value:d,Rc:b});b=l(b,d)}while(b);return c};this.AX=function(b){var c=
"/"+u,d={},e="?";b.forEach(function(a){a.aC&&(c+=e+a.Rc.name+"\x3d"+a.aC,e="\x26");a.Rc.Fi&&(d[a.Rc.name]=a.Rc.Fi)});try{c=m(c,d)}catch(g){a.u.error("Error while building URL: "+g)}return c};this.aw=function(a){var b=a.indexOf("oj_Router\x3d");return-1!=b?a.substr(0,b-1):a};this.GY=function(a){var b=a.indexOf("?"),c=null,c={};-1!=b&&(c=a.substr(b+1),c=g(c));return c}};o_("Router.urlParamAdapter",a.nb.Oha,a);return D})();(function(){a.Wp=function(b,c,d){c=c||{};a.j.il(b);b=encodeURIComponent(b.replace(a.Ba.JD,
""));c.canEnter&&a.j.$r(c.canEnter);c.enter&&a.j.$r(c.enter);c.canExit&&a.j.$r(c.canExit);c.exit&&a.j.$r(c.exit);this.tA=d;this.fC=void 0;Object.defineProperties(this,{id:{value:b,enumerable:!0},value:{value:c.value,writable:!0,enumerable:!0},label:{value:c.label,writable:!0,enumerable:!0},canEnter:{value:c.canEnter,writable:!0,enumerable:!0},enter:{value:c.enter,writable:!0,enumerable:!0},canExit:{value:c.canExit,writable:!0,enumerable:!0},exit:{value:c.exit,writable:!0,enumerable:!0}})};o_("RouterState",
a.Wp,a);a.Wp.prototype.go=function(){return this.tA?this.tA.go(this.id):(a.nb.transitionedToState.dispatch({hasChanged:!1}),Promise.reject(Error("Router is not defined for this RouterState object.")))};a.b.i("RouterState.prototype.go",{go:a.Wp.prototype.go});a.Wp.prototype.mZ=function(){if(!this.tA)throw Error("Router is not defined for this RouterState object.");return this.tA.hf()===this.id};a.b.i("RouterState.prototype.isCurrent",{mZ:a.Wp.prototype.mZ})})()});
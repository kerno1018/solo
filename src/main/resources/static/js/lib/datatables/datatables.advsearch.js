define(["jquery","knockout","datatables","ko-binding-utils","underscore","date-util","moment"],function(e,a,t,r,n,s,i){var o;!function(e,t,r){"use strict";o=function(t,r){var n=this;!this instanceof o&&alert('Warning: AdvancedSearch API must be initialised with the keyword "new"');var i=e.fn.DataTable.Api?new e.fn.DataTable.Api(t).settings():t.fnSettings(),c=i[0];n.searchNumbers=function(a,t){e.fn.DataTable.ext.search.push(function(e,r,n,s){for(var i=!1,o=0;o<t.length;o++){var c=t[o];c.max?"between"===c.opr&&parseInt(r[a])>parseInt(c.min)&&parseInt(r[a])<parseInt(c.max)&&(i=!0):("="===c.opr&&parseInt(r[a])==parseInt(c.min)&&(i=!0),">"===c.opr&&parseInt(r[a])>parseInt(c.min)&&(i=!0),"<"===c.opr&&parseInt(r[a])<parseInt(c.min)&&(i=!0))}return i})},n.searchDates=function(a,t){e.fn.DataTable.ext.search.push(function(e,r,n,s){for(var i=!1,o=0;o<t.length;o++){var c=t[o];c.max?"between"===c.opr&&new Date(r[a])>c.min&&new Date(r[a])<c.max&&(i=!0):("="===c.opr&&new Date(r[a])==c.min&&(i=!0),">"===c.opr&&new Date(r[a])>c.min&&(i=!0),"<"===c.opr&&new Date(r[a])<c.min&&(i=!0))}return i})};var l=function(e,t,r,s,i){var o=this;this.column=a.observable(e),this.dropdownSearchValue="htmlicons"==n.columns[e].type,this.operatorsArr=a.observableArray(n.columns[e].operators?n.columns[e].operators.split(","):n.DEFAULT_OPERATIONS[n.columns[e].type]),this.operator=a.observable(r?r:this.operatorsArr()[0]),this.searchVal=a.observable(t?t:""),this.searchValues=a.observableArray(i?i:[]),this.rangeVal=a.observable(s?s:"");var c;return c="htmlicons"==n.columns[e].type&&n.columns[e].displayOptions?n.columns[e].displayOptions instanceof Array?n.columns[e].displayOptions:n.columns[e].displayOptions.split(","):[],this.ddoptions=a.observableArray(c),this.removeRow=a.observable(!0),this.column.subscribe(function(e){o.dropdownSearchValue="htmlicons"==n.columns[e].type,o.operatorsArr(n.columns[e].operators?n.columns[e].operators.split(","):n.DEFAULT_OPERATIONS[n.columns[e].type]),o.searchVal(""),o.searchValues([]),o.rangeVal(""),"htmlicons"==n.columns[e].type&&o.ddoptions(n.columns[e].displayOptions)}),this.operator.subscribe(function(e){}),this.ddoptions.subscribe(function(e){n._fnCombineSearchCriteria()}),n.searchSettings.options.serverSide||(this.searchVal.subscribe(function(e){n._fnCombineSearchCriteria()}),this.searchValues.subscribe(function(e){n._fnCombineSearchCriteria()}),this.rangeVal.subscribe(function(e){n._fnCombineSearchCriteria()})),this};return this.searchSettings={that:this,tableInstance:t,dt:c,settings:i,custom:{},master:!1,tags:{}},this.dom={container:null},this.viewModel=null,this.columns={},this.DEFAULT_OPERATIONS={string:["Starts With","Contains","Ends With","Equals"],number:["=",">","<","between"],date:["=",">","<","between"],htmlicons:["="]},this.advSearchArray=a.observableArray(),this.columnsArr=a.observableArray(),this.initialSearchCriteria={},this.errors={},this.searchCriteria={},this.dateOptions={format:s.getUserDateFormat(),useCurrent:!1,defaultDate:null},this.classes=e.extend(!0,{},o.classes),this.getSearchObj=function(e,a,t,r,n){return new l(e,a,t,r,n)},this.fnSettings=function(){return this.searchSettings},"undefined"==typeof r&&(r={}),o._aInstances.push(this),this.searchSettings.tableInstance.on("stateSaveParams.dt",function(a,t,r){e.each(n.searchCriteria,function(a,t){var r=n.searchCriteria[a];"date"===r.type&&e.each(r.searchRows,function(e,a){var t=a.value?new Date(a.value).getTime():"";a.value=t;var r=a.max?new Date(a.max).getTime():"";a.max=r})}),r.advSearch=n.searchCriteria}),this._fnConstruct(t,r),this},o.prototype={_fnConstruct:function(t,r){var n=this;n.searchSettings.tags=o.DEFAULTS,n.searchSettings.options=e.extend({},r),n.tableIndex="DataTables_"+this.searchSettings.dt.sTableId+"_advSearch",n._fnBuildSearchButton(),n.searchSettings.dt.aoDestroyCallback.push({sName:"AdvancedSearch",fn:function(){a.cleanNode(n.dom.container),e(n.dom.container).unbind().empty();var t=e.inArray(n,o._aInstances);-1!==t&&o._aInstances.splice(t,1)}}),n.searchSettings.dt.aoServerParams.push({sName:"AdvancedSearch",fn:function(e){e.advSearch=n.searchCriteria}})},_fnBuildSearchButton:function(){var a=this,t=e("#"+a.searchSettings.dt.sTableId+"_filter"),n=r.createElement(a.searchSettings.tags.button);n.className="dropdown-toggle no-margin";var s=r.createElement(a.searchSettings.tags.liner);s.className="fa fa-caret-down";var i=r.createElement(a.searchSettings.tags.liner);i.className="sr-only",n.appendChild(s),n.appendChild(i);var o=r.createElement(a.searchSettings.tags.container);o.className="search-cover";var c=r.createElement(a.searchSettings.tags.link);e(c).attr("title","Collapse Search"),e(c).attr("href","javascript:;"),e(c).text("Collapse ");var l=r.createElement(a.searchSettings.tags.liner);l.className="fa-caret-up fa right",c.appendChild(l),o.appendChild(c),t.append(n),t.append(o),e(n).off().on("click",function(e){a._fnToggleSearchContainer()}),e("#"+a.searchSettings.dt.sTableId+"_wrapper .search-cover").off().on("click",function(){a._fnToggleSearchContainer()}),a._getColNames();var d=a.searchSettings.settings[0].oLoadedState?a.searchSettings.settings[0].oLoadedState.advSearch:{};e.isEmptyObject(d)?e.isEmptyObject(a.initialSearchCriteria)?a.advSearchArray.push(a.getSearchObj(a.columnsArr()[0])):e.each(a.initialSearchCriteria,function(t,r){e.each(r,function(e,r){a.advSearchArray.push(a.getSearchObj(t,r.value,r.opr))}),a._fnCombineSearchCriteria()}):e.each(d,function(t,r){var n=r;if(n){if("htmlicons"==n.type){var s=[];e.each(n.searchRows,function(e,a){s.push(a.value)});var i=!1;e.each(n.searchRows,function(e,t){i||(a.advSearchArray.push(a.getSearchObj(n.title,t.value,t.opr,t.max,s)),i=!0)})}else e.each(n.searchRows,function(e,t){a.advSearchArray.push(a.getSearchObj(n.title,t.value,t.opr,t.max))});a._fnCombineSearchCriteria()}}),a._fnBuildSearchContainer(),a._fnBuildLabelContainer(),a._fnSetInitContainer()},_fnSetInitContainer:function(){var a=this;a.dom.filterContainer=e("#"+this.searchSettings.dt.sTableId+"_wrapper .dataTables_filter"),a.dom.container=e("#"+this.searchSettings.dt.sTableId+"_wrapper .advance-search"),a.dom.advSearchLabels=e("#"+a.searchSettings.dt.sTableId+"_wrapper .advance-search-values"),1==a.advSearchArray().length&&""==a.advSearchArray()[0].searchVal()?(a.dom.advSearchLabels.hide(),a.dom.container.hide(),a.dom.filterContainer.find("label").show(),a.dom.filterContainer.find("button").show(),a.dom.filterContainer.find(".search-cover").hide()):(a.dom.advSearchLabels.show(),a.dom.container.hide(),a.dom.filterContainer.find("label").show(),a.dom.filterContainer.find("button").show(),a.dom.filterContainer.find(".search-cover").hide())},_fnToggleSearchContainer:function(){var a=this;a.dom.filterContainer=e("#"+this.searchSettings.dt.sTableId+"_wrapper .dataTables_filter"),a.dom.container=e("#"+this.searchSettings.dt.sTableId+"_wrapper .advance-search"),a.dom.advSearchLabels=e("#"+a.searchSettings.dt.sTableId+"_wrapper .advance-search-values"),a.dom.container.is(":visible")?(a.dom.container.slideUp(300),a.dom.advSearchLabels.show(),a.dom.filterContainer.find("label").show(),a.dom.filterContainer.find("button").show(),a.dom.filterContainer.find(".search-cover").hide()):(a.dom.container.slideDown(300),a.dom.advSearchLabels.hide(),a.dom.filterContainer.find("label").hide(),a.dom.filterContainer.find("button").hide(),a.dom.filterContainer.find(".search-cover").show()),1==a.advSearchArray().length&&""==a.advSearchArray()[0].searchVal()&&0==a.advSearchArray()[0].searchValues().length&&e(a.dom.advSearchLabels).hide()},_fnGetSearchVal:function(e){if(i.isMoment(e)){var a=this.dateOptions.format;return e.format(a)}return e},_fnGetSearchValues:function(e){return e.join(" or ")},_fnBuildLabelContainer:function(){var t=this,r='<div class="advance-search-values">                                    <span class="label">Advanced Search:</span>                                    <ul  data-bind="foreach:advSearchArray">                                        <li class="value">                                        <!-- ko if:operator() == "between" -->                                            <span data-bind="text:column()+ &quot; &quot; + operator() + &quot; &quot; + $parent._fnGetSearchVal(searchVal()) + &quot; and &quot; + $parent._fnGetSearchVal(rangeVal())"></span>                                        <!--/ko-->                                        <!-- ko ifnot:operator() == "between" -->                                            <!-- ko if: searchValues().length > 0 -->                                                <span data-bind="text:column()+ &quot; &quot; + operator() + &quot; &quot; + $parent._fnGetSearchValues(searchValues())"></span>                                            <!--/ko-->                                            <!-- ko ifnot: searchValues().length > 0 -->                                                <span data-bind="text:column()+ &quot; &quot; + operator() + &quot; &quot; + $parent._fnGetSearchVal(searchVal())"></span>                                            <!--/ko-->                                        <!--/ko-->                                            <a href="javascript:;" class="tipster" title="Remove">                                                <span class="fa-remove fa" data-bind="if:removeRow,click:function(data){$parent._fnRemoveSearch(data)}"></span>                                                <em class="hidden" >Remove</em>                                            </a>                                        </li>                                    </ul>                                    <span class = "value-actions float-right">                                        <a href="javascript:;" data-bind="click:_fnClearSearch">                                            <span class="fa-undo fa"></span>                                            Clear All                                        </a>                                    </span>                                </div>';e(r).insertAfter(e("#"+t.searchSettings.dt.sTableId+"_wrapper .table-actions")),a.applyBindings(t,e("#"+t.searchSettings.dt.sTableId+"_wrapper .advance-search-values")[0])},_fnBuildSearchContainer:function(){var t=this,r='<div class ="advance-search" >                                    <div class="search-top">                                        <h4>Advanced Search </h4>                                        <div class="row">                                            <div class="col-md-3 col-sm-3 col-xs-3">                                                <span class="label">Criteria</span>                                            </div>                                            <div class="col-md-2 col-sm-2 col-xs-3">                                                <span class="label">Operator</span>                                            </div>                                            <div class="col-md-3 col-sm-3 col-xs-2">                                                <span class="label">Value</span>                                            </div>                                            <div class="search-controls col-md-4 pull-right  col-sm-4 col-xs-4">                                                <a href="javascript:;" data-bind="click:_fnClearSearch">                                                    <span class="fa-undo fa left"></span>                                                    Start Over                                                </a>                                                <a href="javascript:;" data-bind="click:_fnAddNewSearch">                                                    <span class="fa-plus fa left"></span>                                                    Add Criteria                                                </a>                                            </div>                                        </div>                                    </div>                                    <div class="search-values"  data-bind="foreach:advSearchArray">                                        <div class="row" >                                             <div class="col-md-3 col-sm-3 col-xs-3">                                                <select data-bind="options: $parent.columnsArr,value:column" ></select>                                            </div>                                            <div class="col-md-2 col-sm-2 col-xs-3">                                                <select data-bind="options: operatorsArr,selectedOptions:operator"></select>                                            </div>                                            <div data-bind = "css:$parent._fnGetCSS(column(),operator())">                                                <!-- ko if:$parent._fnShowInput(column())-->                                                    <acs-input-text params="value: searchVal"></acs-input-text>                                                <!--/ko-->                                                <!-- ko if:$parent._fnShowDate(column())-->                                                    <input data-bind="dateTimePicker:searchVal,dateOptions:$parent.dateOptions" class = "form-control">                                                <!--/ko-->                                                <!-- ko if:$parent._fnShowDropDown(column())-->                                                        <acs-adv-dropdown params="value: searchValues, options: {optionsList: ddoptions, filter: true}, multiple: true, placeholder: &quot;Select Values&quot;"></acs-adv-dropdown>                                                <!--/ko-->                                            </div>                                            <!-- ko if:$parent._fnShowInput(column(),operator())-->                                                <div class="between-label" >                                                    To                                                </div>                                                 <div data-bind = "css:$parent._fnGetCSS(column(),operator())">                                                    <acs-input-text params="value: rangeVal"></acs-input-text>                                                </div>                                            <!--/ko-->                                            <!-- ko if:$parent._fnShowDate(column(),operator())-->                                                <div class="between-label" >                                                    To                                                </div>                                                 <div data-bind = "css:$parent._fnGetCSS(column(),operator())">                                                    <input data-bind="dateTimePicker:rangeVal,dateOptions:$parent.dateOptions" class = "form-control">                                                </div>                                            <!--/ko-->                                            <div class="col-md-1 col-sm-1 col-xs-2 actions">                                                <a href="javascript:;" class="tipster" title="Remove" data-bind="if:removeRow,click:function(data){$parent._fnRemoveSearch(data)}">                                                    <span class="fa-remove fa"></span>                                                    <em class="hidden">Remove</em>                                                </a>                                            </div>                                            <div class="separator-bottom no-padding"></div>                                        </div>                                    </div>                                    <!-- ko if:searchSettings.options["serverSide"] -->                                        <div class = "button-con">                                            <div class="float-right">                                                <a href="javascript:;" class="btn btn-default" data-bind="click:_fnServerSearch">                                                    <span class="fa-check fa left"></span>                                                    Search                                                </a>                                            </div>                                        </div>                                    <!--/ko-->                            </div>';e(r).insertAfter(e("#"+t.searchSettings.dt.sTableId+"_wrapper .table-actions")),a.applyBindings(t,e("#"+t.searchSettings.dt.sTableId+"_wrapper .advance-search")[0])},_getColNames:function(){var a=this,t=a.searchSettings.options,r=a.searchSettings.dt,n=t.preSearchCols;a.preSearchColsList=[],e.each(r.aoColumns,function(e,t){a.preSearchColsList[e]=null,void 0===t.searchable&&(t.searchable=!0),t.searchable&&"_allChildren"!==t.data&&(n&&n[e]&&null!==n[e].search&&(a.initialSearchCriteria[t.title]=n[e].search),a.columns[t.title]="htmlicons"===t.type?{type:t.type,name:t.mData,index:t.idx,displayOptions:t.displayOptions}:{type:t.type||"string",name:t.mData,index:t.idx},t.operators&&(a.columns[t.title].operators=t.operators),a.columnsArr.push(t.title))})},_fnRemoveSearch:function(a){var t=this;t.advSearchArray.remove(a),0===t.advSearchArray().length&&(e(t.dom.advSearchLabels).hide(),t._fnClearSearch()),t.searchCriteria={},t._fnCombineSearchCriteria()},_fnAddNewSearch:function(e){var a=this;a.advSearchArray.push(a.getSearchObj(a.columnsArr()[0]))},_fnGetCSS:function(a,t){var r=this;return-1!=e.inArray(r.columns[a].type,["date","number"])&&"between"==t?"col-md-2 col-sm-2 col-xs-2":"col-md-6 col-sm-6 col-xs-4"},_fnShowInput:function(a,t){var r=this;return arguments.length>1?"date"!==r.columns[a].type&&"between"==t?!0:!1:-1===e.inArray(r.columns[a].type,["date","htmlicons"])?!0:!1},_fnShowDate:function(e,a){var t=this;return arguments.length>1?"date"===t.columns[e].type&&"between"==a?!0:!1:"date"===t.columns[e].type?!0:!1},_fnShowDropDown:function(e){var a=this;return"htmlicons"===a.columns[e].type?!0:!1},_fnClearSearchFilters:function(){for(var a=this,t=0;t<e.fn.DataTable.ext.search.length;t++)e.fn.DataTable.ext.search.splice(t,1);var r=e("#"+a.searchSettings.dt.sTableId).DataTable();a.settings=a.searchSettings.settings,0===a.settings[0].oSavedState.search.search.length&&r.search("").columns().search("").draw()},_fnClearSearch:function(){var a=this;a.advSearchArray.removeAll(),a.searchCriteria={},a.advSearchArray.push(a.getSearchObj(a.columnsArr()[0])),a._fnClearSearchFilters(),1==a.advSearchArray().length&&""==a.advSearchArray()[0].searchVal()&&e(a.dom.advSearchLabels).hide()},_fnGetTableNode:function(a,t){var r=this,n=e("#"+r.searchSettings.dt.sTableId+"_wrapper .adv-search table"),s=e(n).find("tr:eq("+parseInt(a)+") td:eq("+t+")");return s},_fnDrawTable:function(a){var t=this;t._fnClearSearchFilters(),t.settings=t.searchSettings.settings;var r,n;e.each(a,function(e,a){"string"===a.type&&(n=t._fnStringOper(a.searchRows),t.settings.column(a.index).search(n,!0,!1)),"htmlicons"===a.type&&(n=t._fnStringOper(a.searchRows),t.settings.column(a.index).search(n,!0,!1)),("date"===a.type||"number"===a.type)&&(r=t._fnGetCriteriaList(a.searchRows)),t.searchSettings.options.serverSide!==!0||"number"!==a.type&&"date"!==a.type?("number"===a.type&&t.searchNumbers(a.index,r),"date"===a.type&&t.searchDates(a.index,r)):t.searchSettings.dt.aoPreSearchCols[a.index].sSearch=r}),t.searchSettings.options.serverSide||t.searchSettings.tableInstance.draw()},_fnServerSearch:function(){var e=this;e._fnCombineSearchCriteria(),e.searchSettings.tableInstance.ajax.reload()},_fnCombineSearchCriteria:function(){var a=this,t=0;a.searchCriteria={},e.each(a.advSearchArray(),function(r,n){var s=n.column()instanceof Array?n.column()[0]:n.column(),i=a.columns[s],o=n.operator()instanceof Array?n.operator()[0]:n.operator(),c=n.searchVal()instanceof Array?n.searchVal()[0]:n.searchVal(),l=n.searchValues(),d=n.dropdownSearchValue,h=i.name;if(a.searchCriteria[h])a.preSearchColsList[i.index].name=h,d?e.each(l,function(e,r){a.searchCriteria[h].searchRows[t]={opr:o,value:r,max:n.rangeVal(),ddoptions:n.ddoptions()||[]},a.preSearchColsList[i.index].search.push({opr:o,value:r,max:n.rangeVal(),ddoptions:n.ddoptions()||[]}),t++}):(a.searchCriteria[h].searchRows[t]={opr:o,value:c,max:n.rangeVal(),ddoptions:n.ddoptions()||[]},a.preSearchColsList[i.index].search.push({opr:o,value:c,max:n.rangeVal(),ddoptions:n.ddoptions()||[]}),t++);else{var p;if(d){if(!(l.length>0))return;p=l[0]}else p=c;var u={};u[t]={opr:o,value:p,max:n.rangeVal(),ddoptions:n.ddoptions()||[]},a.searchCriteria[h]={title:s,type:i.type,index:i.index,searchRows:u},a.preSearchColsList[i.index]={name:i.name,search:[{opr:o,value:p,max:n.rangeVal(),ddoptions:n.ddoptions()||[]}]},t++,l.length>0&&(a.preSearchColsList[i.index].name=h,e.each(l,function(e,r){e>0&&(a.searchCriteria[h].searchRows[t]={opr:o,value:r,max:n.rangeVal(),ddoptions:n.ddoptions()||[]},a.preSearchColsList[i.index].search.push({opr:o,value:r,max:n.rangeVal(),ddoptions:n.ddoptions()||[]}),t++)}))}}),a.searchSettings.options.serverSide||a._fnDrawTable(a.searchCriteria)},_fnGetCriteriaList:function(a){var t=[];return e.each(a,function(e,r){var n=a[e];r&&t.push("between"==n.opr?{opr:n.opr,min:n.value,max:n.max}:{opr:n.opr,min:n.value})}),t},_fnStringOper:function(t){var r=this,n="";return e.each(t,function(e,s){var i=t[e];void 0!=i.value&&(r.errors[e]&&(a.cleanNode(r._fnGetTableNode(e,2)[0]),delete r.errors[e]),i.value=i.value.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1"),n="Starts With"==i.opr?n+"|^"+i.value:"Equals"==i.opr||"="==i.opr?n+"|^"+i.value+"$":"Ends With"==i.opr?n+"|"+i.value+"$":n+"|"+i.value)}),n.replace("|","")},_fnGetMasterSettings:function(){var e=this;if(e.searchSettings.master)return e.searchSettings;for(var a=o._aInstances,t=0,r=a.length;r>t;t++)if(e.dom.table==a[t].searchSettings.dt.nTable)return a[t].searchSettings}},o._aInstances=[],o.DEFAULTS={container:"div",button:"button",link:"a",liner:"span"},o.classes={dataTable_wrapper:"dataTable_wrapper",container:"adv-search",toggleIcon:"fa fa-caret-down",searchIcon:"fa fa-search",buttons:{normal:"btn btn-default dropdown-toggle",active:"active",disabled:"disabled"}},o.defaults=o.DEFAULTS,o.prototype.CLASS="AdvancedSearch","function"==typeof e.fn.dataTable&&"function"==typeof e.fn.dataTableExt.fnVersionCheck&&e.fn.dataTableExt.fnVersionCheck("1.9.0")?e.fn.DataTable.ext.aoFeatures.push({fnInit:function(e){var a=e.oInit,t=a?a.AdvancedSearch||a.oAdvancedSearch||{}:{};return new o(e.oInstance,t).dom.container},cFeature:"A",sFeature:"AdvancedSearch"}):alert("Warning: AdvancedSearch requires DataTables 1.9.0 or newer - www.datatables.net/download"),e.fn.DataTable.AdvancedSearch=o}(jQuery,window,document)});
define(["jquery","knockout","acs-resource","sql-service","alert-utils","signal-emitter","jquery-treegrid"],function(e,t,a,l,o,i){var n=function(o,n){function s(e,a,l,o,i,n,s,d,r){this.rank=e?e:"-",this.sqlId=a?a:"-",this.executions=l?l:"-",this.bufferGets=o?o:"-",this.elapsedTime=i?i:"-",this.cpuTime=n?n:"-",this.ioWait=s?s:"-",this.diskReads=d?d:"-",this.ioOffloaded=r?r:"-",this.executionList=t.observableArray(),this.action=""}function d(e,a){this.name=e?t.observable(e):t.observable(),this.type=a?t.observable(a).extend({required:!0}):t.observable().extend({required:!0}),this.testValue=t.observable().extend({required:!0}),this.id=e,this.typeInfo="Enter a value of type "+a}var r=this;return r.sqlTableOptions={order:[[0,"asc"]]},r.sqlList=t.observableArray(),r.loading=t.observable(!1),r.topNamedSql=t.observable(-1).extend({required:!0}),r.topNamedSqlName="",r.namedSQLDropDown=t.observableArray([]),r.namedSqlList=[],r.paramList=t.observableArray(),r.sqlQuery=t.observable(),r.sqlSelected=t.observable(!1),r.configureSqlModalTitle=t.observable("Configure Named SQL"),r.configureSqlModalSubtitle=t.observable("Configure the Named SQL for retrieving the top ranked SQL statements"),r.configured=t.observable(!1),r.scenarioId=null,r.instanceNumber=null,r.explainPlanModalTitle=t.observable(),r.topNamedSql.subscribe(function(t){t&&"select named sql"!==t&&(r.sqlSelected(!0),r.paramList.removeAll(),e.each(r.namedSqlList,function(a,l){l.id==t&&(r.sqlQuery(l.sql),r.topNamedSqlName=l.name,e.each(l.paramList,function(e,t){r.paramList.push(new d(t.name,t.type))}))}))}),r.topSqlOptions={optionsList:r.namedSQLDropDown,optionsText:"text",optionsValue:"code",filter:!0,optionsGroup:!1,size:10},r.compareSql=function(e,t){return e.name.toLowerCase()<t.name.toLowerCase()?-1:e.name.toLowerCase()>t.name.toLowerCase()?1:0},r.init=function(){if(o.enable_configuration&&(r.sqlTableOptions.buttonTools={rButtons:[{sExtends:"sample-btn",sButtonText:"Configure",sIconClass:"fa fa-wrench float-left",sButtonClass:"btn-default",fnClick:"showTopSqlConfigModal"}]}),o.top_sql_name&&o.top_sql_bind_variables){var i="";r.configured(!0);for(var n in o.top_sql_bind_variables){var d=t.unwrap(o.top_sql_bind_variables[n]);i.length>0&&(i+="&"),i+=n+"="+d}var p=new a({url:"data/sql/"+o.top_sql_name+"?"+i,global:!1});r.loading(!0),p.get().done(function(a){var l=[];r.loading(!1),e.each(a,function(e,t){l.push(new s(t.RANK,t.SQL_ID,t.EXECUTIONS,t.BUFFER_GETS,t.ELAPSED_TIME_SEC,t.CPU_TIME_SEC,t.IOWAIT_SEC,t.DISK_READS,t.IO_OFFLOADED_PCT))}),t.utils.arrayPushAll(r.sqlList,l)})}else r.sqlTableOptions.buttonTools={rButtons:[{sExtends:"sample-btn",sButtonText:"Configure",sIconClass:"fa fa-wrench float-left",sButtonClass:"btn-default",fnClick:"showTopSqlConfigModal"}]},l.getNamedSqlList(function(a){r.namedSqlList=a,a.sort(r.compareSql);var l=[];l.push({text:"- select named sql -",code:-1}),e.each(a,function(e,t){l.push({text:t.name,code:t.id})}),t.utils.arrayPushAll(r.namedSQLDropDown,l)})},r.renderExplainPlan=function(t){var a='<table id="explain-plan-table" class="tree explain-plan-table" style="width: 100%"><tr><th>Operation</th><th>ID</th><th>DEPTH</th><th>Object</th><th>Rows</th><th>Bytes</th><th>Cost</th></tr>',l=-1,o=0;e.each(t,function(e,t){t.originalID=t.ID,t.ID>l?l=t.ID:(t.ID=l+1,l=t.ID)}),e.each(t,function(e,l){var i=l.Cost,n=l.Operation,s=l.NUM_ROWS,d=l.PHV_Object,r=l.Bytes,p=l.originalID,c=l.DEPTH;if(n=n.trim(),i=i.trim(),s=s.trim(),d=d.trim(),r=r.trim(),s=s.length>0?s:"-",i=i.length>0?i:"-",d=d.length>0?d:"-",r=r.length>0?r:"-",l.DEPTH>0){for(var u,m=e,f=t[e].DEPTH,b=f-1,h=m;h>=0;h--)if(t[h].DEPTH==b){u=t[h].ID;break}a+='<tr class="treegrid-'+l.ID+" treegrid-parent-"+u+'">'}else o>0&&(a+='<tr><td colspan="6"><div style="height: 20px; width: 100%"></div></td></tr>'),a+='<tr class="treegrid-'+l.ID+'">';a+="<td>"+n+"</td><td>"+p+"</td><td>"+c+"</td><td>"+d+"</td><td>"+s+"</td><td>"+r+"</td><td>"+i+"</td></tr>",o++}),a+="</table>",e("#explain-plan-modal-body").html(a),e("#explain-plan-table").treegrid(),e(".treegrid-expander").css("position","relative"),e(".treegrid-expander").css("top","3px")},r.showTopSqlConfigModal=function(){e("#configure-top-sql-modal").modal("show")},r.saveTopSqlConfiguration=function(){var l="",o={};r.configureSqlModalTitle=t.observable("Configure Named SQL"),r.configureSqlModalSubtitle=t.observable("Configure the Named SQL for retrieving the top ranked SQL statements"),e.each(r.paramList(),function(e,t){l.length>0&&(l+="&"),l+=t.name()+"="+t.testValue(),o[t.name()]=t.testValue(),"scenario_id"==t.name()&&(r.scenarioId=t.testValue()),"instance_number"==t.name()&&(r.instanceNumber=t.testValue())}),i.dispatch("Report-Component-Param-Changed",[n.element,"top_sql_name",r.topNamedSqlName]),i.dispatch("Report-Component-Param-Changed",[n.element,"top_sql_bind_variables",o]);var d=new a({url:"data/sql/"+r.topNamedSqlName+"?"+l,global:!1});r.configured(!0),r.loading(!0),d.get().done(function(t){r.loading(!1),e.each(t,function(e,t){r.sqlList.push(new s(t.RANK,t.SQL_ID,t.EXECUTIONS,t.BUFFER_GETS,t.ELAPSED_TIME_SEC,t.CPU_TIME_SEC,t.IOWAIT_SEC,t.DISK_READS,t.IO_OFFLOADED_PCT))}),e("#configure-top-sql-modal").modal("hide")})},r.showExplainPlan=function(l){var i=o.explain_plan_sql_name?o.explain_plan_sql_name:"ptb_rpt_sql_explain_plan",n="sql_id="+l.sqlId;for(var s in o.explain_plan_sql_bind_variables){var d=t.unwrap(o.explain_plan_sql_bind_variables[s]);n+="&"+s+"="+d}e("#explain-plan-modal").find("h1").html("Explain Plan for SQL Id "+l.sqlId),e("#explain-plan-modal-body").empty(),e("#explain-plan-modal-body").html('<h4 class="text-center"><i class="fa-refresh fa-spin fa"></i> Loading...</h4>');var p=new a({url:"data/sql/"+i+"?"+n,global:!1});p.get().done(function(e){r.renderExplainPlan(e)}),e("#explain-plan-modal").modal("show")},r.afterRender=function(){e(".dataTables_empty").html("No SQL statements available. Click the configure button above."),e("#configure-link").on("click",function(){e("#configure-top-sql-modal").modal("show")})},r.saveButtonDisabled=t.computed(function(){var t=!1;return"undefined"==typeof r.topNamedSql()||-1==r.topNamedSql()?!0:(e.each(r.paramList(),function(e,a){a.testValue&&("undefined"==typeof a.testValue()||0==a.testValue().length)&&(t=!0)}),t)}),r.init(),{sqlList:r.sqlList,loading:r.loading,sqlTableOptions:r.sqlTableOptions,showSqlDetailsModal:r.showSqlDetailsModal,showExplainPlan:r.showExplainPlan,saveTopSqlConfiguration:r.saveTopSqlConfiguration,topNamedSqL:r.topNamedSql,topSqlOptions:r.topSqlOptions,paramList:r.paramList,sqlQuery:r.sqlQuery,showTopSqlConfigModal:r.showTopSqlConfigModal,sqlSelected:r.sqlSelected,explainPlanModalTitle:r.explainPlanModalTitle,configureSqlModalTitle:r.configureSqlModalTitle,configureSqlModalSubtitle:r.configureSqlModalSubtitle,configured:r.configured,afterRender:r.afterRender,saveButtonDisabled:r.saveButtonDisabled}};return{viewModel:{createViewModel:n},template:'<table id="top-sql-table" class="table dataTable" data-bind="dataTable: {data: sqlList, options: sqlTableOptions, inProgress: loading}">                    <col data="sqlId" title="SQL Id" targets=1 width="16%" template="<a href=\'javascript:;\' class=\'main-name\' col-data-bind=\'html: sqlId, click: $data.showExplainPlan\'></a>">                    <col data="elapsedTime" title="Elapsed Time (sec)" targets=2 width="14%">                    <col data="executions" title="Executions" targets=4 width="14%">                    <col data="bufferGets" title="Buffer Gets" targets=3 width="14%">                    <col data="diskReads" title="Disk Reads" targets=8 width="14%">                    <col data="cpuTime" title="CPU Time (sec)" targets=5 width="14%">                    <col data="ioWait" title="IO Wait (sec)" targets=6 width="14%">                </table>                <acs-modal-dialog params="title: explainPlanModalTitle,                                        titleIconClass: \'fa-exchange icon blue\',                                        subtitle: \'View more information below\',                                        id: \'explain-plan-modal\',                                        bodyTemplate: \'explain-plan-modal-body-template\',                                        viewModel: $data,                                        width: \'modal-lg\',                                        showActionButton: false,                                        showCancelButton: false,                                        showCloseButton: true">                </acs-modal-dialog>                <script type="text/template" id="explain-plan-modal-body-template">                    <div id="explain-plan-modal-body" class="modal-body" style="overflow-y: auto; height: 400px">                    </div>                </script>                <acs-modal-dialog params="title: \'Configure Named SQL\',                                        titleIconClass: \'fa-gear icon blue\',                                        subtitle: \'Configure the Named SQL for retrieving the top ranked SQL statements\',                                        id: \'configure-top-sql-modal\',                                        bodyTemplate: \'configure-top-sql-modal-body\',                                        viewModel: $data,                                        alertParentNodeId: \'configModalAlertContainer\',                                        actionButtonLabel: \'Save\',                                        actionButtonCallback: saveTopSqlConfiguration,                                        actionButtonDisabled: saveButtonDisabled,                                        actionButtonClass: \'fa fa-check left\',                                        actionButtonId: \'save-button\'">                </acs-modal-dialog>                <script type="text/template" id="configure-top-sql-modal-body">                   <div style="height: 400px; overflow-y: auto; overflow-x: hidden">                       <div class="row">                            <acs-adv-dropdown                                 params="label: \'Named SQL\',                                        labelWidth: \'col-md-4\',                                        fieldWidth: \'col-md-6\',                                        title: \'Select a named SQL to retreive the top ranked SQL statements\',                                        value: topNamedSqL,                                        id: \'namedSQLList\',                                        options: topSqlOptions">                            </acs-adv-dropdown>                        </div>                        <hr>                        <!-- ko if:sqlSelected() -->                            <div class="row">                                <div class="col-md-12">                                    <pre class="prettyprint lang-sql"><code data-bind="text:sqlQuery"></code></pre>                                </div>                            </div>                            <hr>                            <div data-bind="foreach: paramList">                                <div class="row">                                    <acs-input-text params="label:  name,                                                            labelWidth: \'col-md-4\',                                                            fieldWidth: \'col-md-6\',                                                            id: id,                                                            title: typeInfo,                                                            value: testValue">                                    </acs-input-text>                                </div>                            </div>                        <!-- /ko -->                   </div>                </script>                <span data-bind="template: { afterRender: afterRender }">'}});
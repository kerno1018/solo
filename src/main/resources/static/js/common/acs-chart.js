define(["jquery","knockout","acs-resource","jsonPath","ojs/ojcore","ojs/ojknockout","ojs/ojchart"],function(e,r,t,n){var a="chartbuilder/chart",i="data/sql",o="namedSql",s=(new Date).getFullYear(),l=new t({url:a,global:!1,idAttribute:"name"}),c=new t({url:i,global:!1}),u=new t({url:o,global:!1}),d=function(t){var a,i,o,d=Math.floor(16777216*(1+Math.random()))+"-"+(new Date).getTime(),p=r.observable("bar"),f=r.observableArray([]),h=r.observableArray([]),v=r.observableArray(),g=r.unwrap(t.renderer||"chart"),b=r.isObservable(t.name)?t.name:r.observable(t.name),m=r.unwrap(t["instance-qualifier"]),y=r.unwrap(t["secondary-qualifier"]),w=r.unwrap(t["bind-variable"]||{}),S=r.unwrap(t["event-listeners"]||{}),A=r.unwrap(t.width||"100%"),x=r.unwrap(t.height||"300px"),j=r.unwrap(t.viewportMin||null),O=r.unwrap(t.viewportMax||null),M=r.isObservable(t.zoomAndScroll)?t.zoomAndScroll:r.observable(t.zoomAndScroll),D=t.outputDescription,N=t.outputExplanation,T=new Date,z=r.unwrap(t.definition),J=function(n,a,i){return z?(r.isObservable(t.definition)&&t.definition.subscribe(function(e){_(e).done(L)}),e.Deferred(function(e){setTimeout(function(){e.resolve(z)},200)}).promise()):l.get({name:n,instance_qualifier:a,secondary_qualifier:i})},_=function(r){var t;if(!r)return e.Deferred(function(e){e.reject("No Chart Definition Found")}).promise();a=r;try{i=JSON.parse(a.configuration)||{}}catch(n){throw n.message="Unable to parse chart Configuration object, probably invalid JSON format: "+n.message,n}try{t=i.defaultBindVariables?JSON.parse(i.defaultBindVariables):{}}catch(n){throw n.message="Unable to parse chart default bind variables object, probably invalid JSON format: "+n.message,n}if(w=e.extend({},t,w),"NAMEDSQL"===r.dataSource||"NAMED_SQL"===r.dataSource)return q(r.dsNamedSqlID,w);if("REST"===r.dataSource)return E(r.dsUrl,w);if("JSON"===r.dataSource)try{return e.Deferred(function(e){e.resolve(JSON.parse(r.dsJson))}).promise()}catch(n){throw n.message="Unable to parse chart JSON data, probably invalid JSON format: "+n.message,n}},q=function(r,t){return e.Deferred(function(n){u.get({id:r}).done(function(r){var a=e.extend({},t,{id:r.name});c.get(a).done(function(e){n.resolve(e)}).fail(function(e){console.log(e)})})}).promise()},E=function(t,n){function a(t,n){var a=t.match(/\{(.*?)\}/g);return a&&e.each(a,function(e,a){t=t.replace(a,r.unwrap(n[a.replace(/[\{\}]/g,"")]))}),t}return e.ajax({url:a(t,n)})},Y=function(e,r){return r&&"string"==typeof r&&r.match(/^\$(.+)/)?n({json:e,path:r}):r},k=function(r,t){return t.series instanceof Array&&"combo"!=i.type?t.series:t.series instanceof Array&&"combo"==i.type&&i.series instanceof Array&&i.series.length>=1?e.map(t.series,function(e,r){return i.series[r]&&i.series[r].assignedToY2&&(e.assignedToY2=i.series[r].assignedToY2),i.series[r]&&i.series[r].type&&(e.type=i.series[r].type),e}):i.series instanceof Array&&i.series.length>=1?e.map(i.series,function(e){return e.name=Y(t,e.name),e.items=Y(t,e.items),e}):null},C=function(r,t){return t.groups instanceof Array?t.groups:"string"==typeof i.groups?i.groups.indexOf(",")>=0?i.groups.split(","):Y(t,i.groups):i.groups instanceof Array&&i.groups.length>0?e.map(i.groups,function(e){return Y(t,e)}):null},F=function(){var t=e("div#"+d);if(t.children().length>0){if(t.find(".acs-chart-component").length>0)return;t.empty()}var n=e.extend({},i,{component:"ojChart",type:"{{type}}",series:"{{series}}",groups:"{{groups}}"});null!=j&&null!=j&&(n.xAxis=n.xAxis||{},n.xAxis.viewportMin="{{viewportMin}}",n.xAxis.viewportMax="{{viewportMax}}"),n.zoomAndScroll&&(n.zoomAndScroll="{{zoomAndScroll}}");var a=r.computed(function(){return"off"==M()?"off":M()?M():i.zoomAndScroll?i.zoomAndScroll:"off"}),o=JSON.stringify(n);o=o.replace('"{{type}}"',"type").replace('"{{series}}"',"series").replace('"{{groups}}"',"groups").replace('"{{viewportMin}}"',"viewportMin").replace('"{{viewportMax}}"',"viewportMax").replace('"{{zoomAndScroll}}"',"zoomAndScroll");var s=e('<div style="position:relative"><div id="'+d+'-chart" class="acs-chart-component" data-bind=\'ojComponent: '+o+' ,style: { width: width, minHeight: height }\'></div><div class="chart-inner-overlay" style="height:'+x+";width:"+A+';opacity:100;top:0;left:0;background:#eee;position:absolute;z-index:1000;text-align: center"><div class="oj-chart empty-content"><div class="spinner-circle"><div class="circle-maker bg-orange medium"><div class="fa-refresh fa-spin fa txt-white"></div></div><p class="txt-gray">Loading...</p></div></div></div></div>');t.append(s);var l={id:d,type:p,series:f,groups:h,viewportMin:j,viewportMax:O,zoomAndScroll:a,width:A,height:x};r.applyBindings(l,s[0]),s.on("ojviewportchange",S.ojviewportchange);try{var c=e("#"+d+"-chart",s).ojChart("whenReady");c&&"function"==typeof c.then&&c.then(function(){setTimeout(function(){e(".chart-inner-overlay",s).remove()},500)})}catch(u){setTimeout(function(){e(".chart-inner-overlay",s).remove()},500)}},B=function(e){F(),p(a.type),f(k(a,e)),h(C(a,e))},P=function(t){var n=e("div#"+d);if(n.children().length>0){if(n.find(".acs-table-component").length>0)return;n.empty()}var o='<div data-bind="style: {width: width}"><table id="'+d+'-table" class="table dataTable" data-bind="dataTable :{data: tableData, options: {searching :false, advancedSearch: true}}"><colgroup>';if("table"===a.type&&i.series.length>0)e.each(i.series,function(e,r){o+='<col data="col'+e+'" title="'+r.name+'" targets="'+e+'" '+(r.number?'class="text-right"':"")+"></col>"});else{var s=t&&t.length>0?t[0]:{Empty:""},l=0;for(var c in s)l++,s.hasOwnProperty(c)&&(o+='<col data="'+c+'" title="'+c+'" targets="'+l+'" '+("number"==typeof s[c]?'class="text-right"':"")+"></col>")}o+="</colgroup></table></div>";var u=e(o);n.append(u);var p={tableData:v,height:x,width:A};r.applyBindings(p,u[0])},U=function(r){var t,n=[];if("table"===a.type)if(t=k(a,r),null===t&&r instanceof Array)e.each(r,function(e,r){n.push(H(r))});else for(var i=0;i<t[0].items.length;i++){var s={};e.each(t,function(e,r){var t="col"+e;s[t]=r.items[i]}),n.push(s)}else if(o instanceof Array)e.each(o,function(e,r){n.push(H(r))});else{if(!(r.series instanceof Array))throw new Error("Failed to render a table: the json data is not in the right format for a table");for(var i=0;i<r.series[0].items.length;i++){var s={};e.each(r.series,function(e,t){r.groups instanceof Array&&(s.Group=H(r.groups[i]));var n=t.name;s[n]=null==t.items[i]?"N/A":t.items[i]}),n.push(s)}}P(n),v(n)},H=function(e,r){function t(e){return e>=10?e:"0"+e}if("object"==typeof e)for(var n in e)e.hasOwnProperty(n)&&(e[n]=H(e[n]));return"number"==typeof e&&e>1e12&&2e12>e?(T.setTime(e),T.getFullYear()>s||T.getFullYear()<s-3?null==e?"":e:r?T.toISOString():T.getFullYear()+"-"+t(T.getMonth()+1)+"-"+t(T.getDate())+" "+t(T.getHours())+":"+t(T.getMinutes())+":"+t(T.getSeconds())):null==e?"":e},L=function(e){o=e,"table"===a.type||"table"===g?U(e):B(e),"function"==typeof D&&D(a.description),"function"==typeof N&&N(a.explanation)},R=function(e){e=e||b(),"__NO_CHART_SET__"!==e&&J(e,m,y).then(_).done(L).fail(function(e){console.error(e)})};R(),b.subscribe(function(e){r.isObservable(t["bind-variable"])&&(w=r.unwrap(t["bind-variable"])),R(e)});for(var V in w)w.hasOwnProperty(V)&&r.isObservable(w[V])&&w[V].subscribe(function(){_(a).done(L)});return r.isObservable(t.renderer)&&t.renderer.subscribe(function(e){g=e,L(o)}),{id:d}};return{viewModel:{createViewModel:d},template:'<div data-bind="attr: {\'id\': id}" style="width: 100%; height: 100%"><div style="height: 300px; width: 100%; text-align: center"></div></div>'}});
define(["jquery","knockout","knockout.mapping","signal-emitter","underscore","acs-resource","httputils","dialog-utils","alert-utils","text!./templates/acs-report-recommendation.tmpl.html","text!./templates/recommendation-basic-config-modal-body.tmpl.html","text!./templates/recommendation-configure-chart-modal-body.tmpl.html","text!./templates/recommendation-select-chart-modal-body.tmpl.html","text!./resources/recommendation_categories.json"],function($,ko,mapping,signalEmitter,_,RestResource,httpUtil,dialog,alert,recoComponentTemplate,cfgRecoModalBodyTemplate,configureChartModalTemplate,selectChartModalTemplate,staticRecoCategories){function ConfigureChartModalVM(e,t,o){var a=this,n="chartbuilder/charts";a.chartList=ko.observableArray(),a.chartDef=ko.observable(),a.params=ko.observableArray(),a.chartName=ko.computed(function(){return a.chartDef()?a.chartDef().name:""}),a.reportParams=ko.observableArray(),a.chartTableOptions={order:[[1,"asc"]],emptyTable:"Loading...",pageLength:5,lengthMenu:[5,10,25,50,100],settings:!1},a.chartsResource=new RestResource({url:n,global:!1}),a.beforeRoutingAction=function(){a.chartsResource.get().done(function(e){var t=[];$.each(e,function(e,o){o.radioButton="",o.selectButton="",t.push(o)}),a.chartList(t)})},a.showConfigureChartModal=function(){a.reportParams(s(e)),$("#recommendation-configure-chart-modal",t.element).modal("show")},a.closeSelectChartDialog=function(){$("#recommendation-select-chart-modal",t.element).modal("hide")},a.openSelectChartDialog=function(){(!a.chartList()||a.chartList().length<1)&&a.beforeRoutingAction(),$("#recommendation-select-chart-modal",t.element).modal("show")},a.saveConfiguration=function(){a.chartDef().params=a.params(),o(a.chartDef()),$("#recommendation-configure-chart-modal",t.element).modal("hide")},a.saveConfigureDisabled=ko.computed(function(){return!a.chartDef()},a),a.selectChart=function(e){a.chartDef(a.chartList()[e]),i(a.chartDef()),a.closeSelectChartDialog()},a.addNewBindParam=function(){a.params.push({name:ko.observable(),value:ko.observable()})},a.setParamValue=function(e,t){e.value(t)},a.removeParam=function(e){a.params.splice(e,1)};var r=function(e){return $.ajax({url:"rest/namedSql/"+e,dataType:"json"})},i=function(e){var t=[];if(!e)return t;if("NAMED_SQL"==e.dataSource)r(e.dsNamedSqlID).then(function(e){$.each(e.paramList,function(e,o){t.push({name:ko.observable(o.name),value:ko.observable("$report."+o.name)})}),a.params(t)});else if("REST"==e.dataSource&&e.dsUrl){var o=e.dsUrl.match(/\{(.*?)\}/g);o&&$.each(o,function(e,o){t.push({name:ko.observable(o.substring(1,o.length-1)),value:ko.observable()})}),a.params(t)}else a.params(t)},s=function(e){var t=e.$report,o=[];for(var a in t)t.hasOwnProperty(a)&&o.push("$report."+a);return o};a.chartTypeArray=[{status:"area",title:"Area",container:"status left tipster",statusIcon:"fa fa-area-chart fa-2x icon",badgeIcon:"",showLabel:!0},{status:"bar",title:"Bar",container:"status left tipster",statusIcon:"fa fa-bar-chart fa-2x icon",badgeIcon:"",showLabel:!0},{status:"line",title:"Line",container:"status left tipster",statusIcon:"fa fa-line-chart fa-2x icon",badgeIcon:"",showLabel:!0},{status:"pie",title:"Pie",container:"status left tipster",statusIcon:"fa fa-pie-chart fa-2x icon",badgeIcon:"",showLabel:!0},{status:"table",title:"Table",container:"status left tipster",statusIcon:"fa fa-table fa-2x icon",badgeIcon:"",showLabel:!0}]}var SEVERITY={CRITICAL:"Critical",WARNING:"Warning",INFO:"Info"},STATUS={IN_PROGRESS:"InProgress",COMPLETED:"Completed",CANCELLED:"Cancelled"},IMPACT={HIGH:"High",MEDIUM:"Medium",LOW:"Low"},RECO_PROPERTIES=["assessment_id","engagement_id","category_id","target_id","target_name","target_guid"],FLAT_CATEGORY_OPTIONS=[],UNSELECTABLE_GROUP_CATEGORY_OPTIONS=ko.observableArray(),SELECTABLE_GROUP_CATEGORY_OPTIONS=ko.observableArray(),_setupRecoCategoryOptions=function(e,t){var o=_.isEmpty(e.categories)?JSON.parse(t):e.categories;_.map(o,function(e,t){var o={label:ko.observable(t),code:ko.observable(("All Categories"==t?"%":t.replace(/[^a-zA-Z0-9_]/g,"_"))+"-%"),isGroup:!0};FLAT_CATEGORY_OPTIONS.push(o),SELECTABLE_GROUP_CATEGORY_OPTIONS.push(o),UNSELECTABLE_GROUP_CATEGORY_OPTIONS.push({label:ko.observable(t),children:ko.observableArray(_.map(e,function(e){var o={label:ko.observable(e),code:ko.observable(t.replace(/[^a-zA-Z0-9_]/g,"_")+"-"+e.replace(/[^a-zA-Z0-9_]/g,"_")),isGroup:!1};return FLAT_CATEGORY_OPTIONS.push(o),SELECTABLE_GROUP_CATEGORY_OPTIONS.push(o),o}))})})},buildRecoComponentVM=function(params,componentInfo){var componentCtx;if(_.isEmpty(params.componentContext)){var $data=ko.dataFor(componentInfo.element),$reportCtx=_.extend({},$data.$report);componentCtx=mapping.fromJS({assessment_id:params.assessment_id||$reportCtx.assessment_id,engagement_id:params.engagement_id||$reportCtx.engagement_id,category_id:params.category_id,instanceList:params.instance_list||$reportCtx.instance_list||[],default_instance:params.default_instance||$reportCtx.default_instance,hideRecommendationsList:params.hideRecommendationsList||!1,instanceQualifier:params.instance_qualifier||$data.$report_instance_id,instanceIdProperty:params.instance_id_property||"id",instanceLabelProperty:params.instance_label_property||"name",saveCallback:params.saveCallback,selectedRecommendation:params.selectedRecommendation,saveCategoryChange:"undefined"==typeof params.save_category_change?!0:params.save_category_change,showCustomization:"undefined"==typeof params.customizationEnabled?!1:params.customizationEnabled,showCategoryList:"undefined"==typeof params.show_category_list?!1:params.show_category_list},{copy:["selectedRecommendation","instanceList","instanceIdProperty","instanceLabelProperty","saveCallback"]})}else componentCtx=params.componentContext;_setupRecoCategoryOptions(params,staticRecoCategories);var recommendations=ko.observableArray([]),selectedReco=ko.observable(),selectedCategoryOption=ko.pureComputed({read:function(){return _.find(FLAT_CATEGORY_OPTIONS,function(e){return e.code()==componentCtx.category_id()})},write:function(e){e&&(componentCtx.category_id(e.code()),componentCtx.hideRecommendationsList()||loadRecommendations(_recoDTOstoVOs),componentCtx.saveCategoryChange()&&signalEmitter.dispatch("Report-Component-Param-Changed",[componentInfo.element,"category_id",componentCtx.category_id()]))}}),cfgRecoModalVM=_buildCfgRecoModalVM(selectedReco,$data,componentInfo,componentCtx),cfgChartModalVMContainer=ko.observable(),loadRecommendations=function(e){if(_.isEmpty(componentCtx.selectedRecommendation)){var t={},o={};if(!componentCtx.category_id()&&!componentCtx.assessment_id())throw new Error("Must specify at least category_id or assessment_id for acs-report-recommendation!");componentCtx.category_id()&&componentCtx.assessment_id()?(_.extend(t,{k1:"category_id",v1:componentCtx.category_id(),k2:"assessment_id",v2:componentCtx.assessment_id()}),o=new RestResource({url:"recommendations/properties",global:!1})):(_.extend(t,{k:componentCtx.category_id()?"category_id":"assessment_id",v:componentCtx.category_id()?componentCtx.category_id():componentCtx.assessment_id()}),o=new RestResource({url:"recommendations/property",global:!1})),o&&o.get(t).done(function(t){e(t),$(".tipster").tooltipster({position:"top",theme:"tooltipster-shadow"})})}else{var a=mapping.toJS(componentCtx.selectedRecommendation),n=ko.unwrap(componentCtx.instanceList),r=[],i=function(){if(a.targetId)return a.targetId;for(var e in n){var t=n[e];if(t.guid==a.targetGuid||t.name==a.targetName)return t.id}return""},s=function(){if(a.targetGuid)return a.targetGuid;for(var e in n){var t=n[e];if(t.id==a.targetId||t.name==a.targetName)return t.guid}return""},c=function(){if(a.targetName)return a.targetName;for(var e in n){var t=n[e];if(t.id==a.targetId||t.guid==a.targetGuid)return t.name}return""};r.push({id:a.id,impact:a.impact,severity:a.severity,status:a.status,text:JSON.stringify({name:a.name,recommendation:a.recommendation,justification:a.justification,support:a.support}),props:{target_name:c(),category_id:a.category,assessment_id:a.assessmentId,engagement_id:a.engagementId,target_id:i(),target_guid:s()}}),e(r)}},createReco=function(){cfgRecoModalVM.setMode("create").showModal()},editReco=function(e){selectedReco(e),cfgRecoModalVM.setMode("edit").showModal()},deleteReco=function(e){dialog.confirmationDialog("Are you sure you want to delete this recommendation?",function(){_resetSelectedReco();var t=new RestResource({url:"recommendations",global:!1}),o={id:e.id()};t.remove(o).done(function(){recommendations.remove(e)})})},closeReco=function(e){var t=new RestResource({url:"recommendations",global:!1}),o=_recoVOtoDTO(e),a=e.instanceName();o.status=STATUS.CANCELLED,t.update(o).done(function(t){mapping.fromJS(_recoDTOtoVO(t),e),e.collapsed(!1),e.instanceName(a)})},reopenReco=function(e){var t=new RestResource({url:"recommendations",global:!1}),o=_recoVOtoDTO(e),a=e.instanceName();o.status=STATUS.IN_PROGRESS,t.update(o).done(function(t){mapping.fromJS(_recoDTOtoVO(t),e),e.collapsed(!1),e.instanceName(a)})},saveReco=function(){if(_isRecoValid()){var e=new RestResource({url:"recommendations",global:!1}),t=_recoVOtoDTO(cfgRecoModalVM);cfgRecoModalVM.inProgress(!0),"create"==cfgRecoModalVM.mode()?e.add(t).done(function(e){var t=_recoDTOtoVO(e);_registerComputed(t),_isSubsetCategory(componentCtx.category_id(),t.category_id())&&recommendations.push(t),alert.showSuccessAlert("Recommendation has been created")}).always(function(){cfgRecoModalVM.inProgress(!1),cfgRecoModalVM.closeModal(),_resetSelectedReco()}):"edit"==cfgRecoModalVM.mode()&&e.update(t).done(function(e){componentCtx.hideRecommendationsList()||(mapping.fromJS(_recoDTOtoVO(e),selectedReco()),selectedReco().collapsed(!1),"undefined"!=typeof componentCtx.category_id()&&"undefined"!=typeof selectedReco().category_id()&&(_isSubsetCategory(componentCtx.category_id(),selectedReco().category_id())||(recommendations.remove(selectedReco()),_resetSelectedReco()))),componentCtx.saveCallback&&componentCtx.saveCallback(e),alert.showSuccessAlert("Recommendation has been updated")}).always(function(){cfgRecoModalVM.inProgress(!1),cfgRecoModalVM.closeModal(),_resetSelectedReco()})}},toggleShowMoreInformation=function(e){if(e.showMoreInformation(!e.showMoreInformation()),e.showMoreInformation()){var t=e.charts.removeAll();_.each(t,function(t){e.charts.push(t)})}},addSupportInformation=function(e){selectedReco(e);var t=new ConfigureChartModalVM($data,componentInfo,function(t){if(t){var o=_chartVOtoChartSnapshot(t,e);_saveSupportInformation(o,e)}});cfgChartModalVMContainer({cfgChartModalVM:t}),t.showConfigureChartModal()},deleteSupportInformation=function(e,t){dialog.confirmationDialog("Are you sure to delete this support information?",function(){var o=_chartVOtoChartSnapshot(e,t),a=new RestResource({url:"recommendations",global:!1}),n=_recoVOtoDTO(t),r=JSON.parse(n.text),i=_.findIndex(r.support,function(e){return e.chart_name==o.chart_name&&JSON.stringify(e.bind_variable)==JSON.stringify(o.bind_variable)});i>-1&&r.support.splice(i,1),n.text=JSON.stringify(r),a.update(n).done(function(e){mapping.fromJS(_recoDTOtoVO(e),t)})})},toggleCollapse=function(e,t){var o=$(t.target),a=o.parents(".recommendation-panel"),n=a.find(".panel-body");n.slideToggle(),e.collapsed(!e.collapsed()),e.showMoreInformation(!e.showMoreInformation())},_resetSelectedReco=function(){selectedReco(0==recommendations().length?null:recommendations()[0])},_recoDTOstoVOs=function(e){var t=[];$.each(e,function(e,o){var a=_recoDTOtoVO(o);_registerComputed(a),t.push(a)}),recommendations(t),_resetSelectedReco()},_recoDTOtoVO=function(e){var t=JSON.parse(e.text),o=mapping.fromJS(_.extend({recommendation:$("<div/>").html(t.recommendation).text(),justification:$("<div/>").html(e.justification).text(),id:e.id,impact:e.impact,name:t.name,severity:e.severity,status:e.status,charts:t.support||[],showMoreInformation:!1,instanceName:e.props.target_name||"All Instances",collapsed:ko.observable(!0),toggleCollapse:toggleCollapse},e.props),{charts:{key:function(e){return e.chart_name+JSON.stringify(e.bind_variable)},create:function(e){return e.data}}});return o},_registerComputed=function(e){e.showMoreInformationClass=ko.pureComputed(function(){return e.showMoreInformation()?"fa fa-caret-down vertical-center":"fa fa-caret-right vertical-center"}),e.showJustification=ko.pureComputed(function(){return e.showMoreInformation()&&!!e.justification()}),e.showSupportInformation=ko.pureComputed(function(){return e.showMoreInformation()&&(e.charts().length>0||componentCtx.showCustomization())}),e.showAddSupportInformation=ko.pureComputed(function(){return e.showMoreInformation()&&componentCtx.showCustomization()})},_registerSubscribers=function(e){!!e.selectedRecommendation&&ko.isObservable(e.selectedRecommendation.edit)&&e.selectedRecommendation.edit.subscribe(function(t){t&&(loadRecommendations(_recoDTOstoVOs),cfgRecoModalVM.setMode("edit").showModal(),e.selectedRecommendation.edit(!1))}),ko.isObservable(e.hideRecommendationsList)&&e.hideRecommendationsList.subscribe(function(e){e||loadRecommendations(_recoDTOstoVOs)}),ko.isObservable(e.assessment_id)&&e.assessment_id.subscribe(function(e){e&&loadRecommendations(_recoDTOstoVOs)}),ko.isObservable(e.category_id)&&e.category_id.subscribe(function(e){e&&loadRecommendations(_recoDTOstoVOs)})},_recoVOtoDTO=function(e){var t=mapping.toJS(e),o={justification:t.justification,impact:t.impact,severity:t.severity,status:t.status,text:JSON.stringify({name:t.name,recommendation:t.recommendation,support:t.charts}),props:{}};for(var a in t)-1!=$.inArray(a,RECO_PROPERTIES)&&(o.props[a]=t[a]);t.id&&(o.id=t.id),o.props.assessment_id=componentCtx.assessment_id(),o.props.engagement_id=componentCtx.engagement_id();var n=_isAllInstances(t.target_id,t.target_guid);return o.props.target_guid="",_.each(ko.unwrap(componentCtx.instanceList),function(e){n?(delete o.props.target_name,o.props.target_guid+=e.guid+","):e.id==t.target_id&&(o.props.target_name=e.name,o.props.target_guid=e.guid)}),o.props.target_guid=n?o.props.target_guid.replace(/,\s*$/,""):o.props.target_guid,o},_isAllInstances=function(e,t){return!e&&!t},_saveSupportInformation=function(e,t){var o=new RestResource({url:"recommendations",global:!1}),t=t,a=_recoVOtoDTO(t),n=JSON.parse(a.text);n.support||(n.support=[]),n.support.push(_.omit(e,"reco")),a.text=JSON.stringify(n),o.update(a).done(function(e){mapping.fromJS(_recoDTOtoVO(e),t)})},_isRecoValid=function(){return ko.validation.group(cfgRecoModalVM,{evaluate:!0}),!(cfgRecoModalVM.errors().length>0)},_isSubsetCategory=function(e,t){return e==t||e.indexOf("-%")>-1&&e.split("-")[0]==t.split("-")[0]||"%"==e.split("-")[0]},_chartVOtoChartSnapshot=function(chart,reco){var unwrappedRecoVO=mapping.toJS(reco),snapshot={bind_variable:chart.bind_variable?chart.bind_variable:{},chart_name:chart.name||chart.chart_name,selected_instance_idx:[],instance_qualifier:componentCtx.instanceQualifier(),instance_property_in_bindvariable:"instance_number",show_customization:componentCtx.showCustomization(),title:httpUtil.htmlDecode(chart.description),type:chart.type},instanceList=ko.unwrap(componentCtx.instanceList),indexArray=_.range(instanceList.length),instanceId=unwrappedRecoVO.target_id?unwrappedRecoVO.target_id:componentCtx.default_instance();if(instanceId){var instanceIdx=_.find(indexArray,function(e){return instanceList[e][componentCtx.instanceIdProperty]==instanceId});snapshot.selected_instance_idx.push(instanceIdx)}else snapshot.selected_instance_idx=indexArray;return _.each(chart.params,function(param){var name=ko.unwrap(param.name),value=ko.unwrap(param.value);snapshot.bind_variable[name]=value&&value.startsWith("$report")?ko.unwrap(eval("$data."+value)):value}),snapshot.instance_list=componentCtx.instanceList,snapshot};return _registerSubscribers(componentCtx),componentCtx.hideRecommendationsList()||loadRecommendations(_recoDTOstoVOs),{STATUS:STATUS,categoryOptions:SELECTABLE_GROUP_CATEGORY_OPTIONS,count:ko.pureComputed(function(){return recommendations().length}),showCustomization:componentCtx.showCustomization,showCategoryList:ko.pureComputed(function(){return(componentCtx.showCategoryList()||componentCtx.showCustomization())&&_.isEmpty(componentCtx.selectedRecommendation)}),recommendations:recommendations,selectedCategoryOption:selectedCategoryOption,createRecommendation:createReco,editRecommendation:editReco,deleteRecommendation:deleteReco,closeRecommendation:closeReco,reopenRecommendation:reopenReco,saveRecommendation:saveReco,addSupportInformation:addSupportInformation,deleteSupportInformation:deleteSupportInformation,toggleShowMoreInformation:toggleShowMoreInformation,cfgRecoModalVM:cfgRecoModalVM,cfgChartModalVMContainer:cfgChartModalVMContainer,hideRecommendationsList:componentCtx.hideRecommendationsList}},DEFAULT_RECOMMENDATION={category_id:"",name:"",target_id:"",target_guid:"",impact:IMPACT.MEDIUM,severity:SEVERITY.INFO,recommendation:"",justification:"",status:STATUS.IN_PROGRESS},validationRequired={create:function(e){return new ko.observable(e.data).extend({required:!0})}},RECOMMENDATION_VALIDATION_MAPPING={name:{create:function(e){return new ko.observable(e.data).extend({required:!0,maxLength:255})}},impact:validationRequired,severity:validationRequired,recommendation:validationRequired,status:validationRequired};define("text!recommendation-basic-config-modal-body.tmpl.html",function(){return cfgRecoModalBodyTemplate}),ko.bindingHandlers.option={update:function(e,t){var o=ko.utils.unwrapObservable(t());ko.selectExtensions.writeValue(e,o)}};var _buildCfgRecoModalVM=function(e,t,o,a){var n=ko.observable("create"),r=mapping.fromJS(DEFAULT_RECOMMENDATION,RECOMMENDATION_VALIDATION_MAPPING);e(r);var i=function(){if(r.errors)for(var e in RECOMMENDATION_VALIDATION_MAPPING)r[e].clearError()},s=function(){if(i(),"create"==n()){var t=a.category_id();if(-1==t.indexOf("-%"))DEFAULT_RECOMMENDATION.category_id=t;else if("%-%"==t)DEFAULT_RECOMMENDATION.category_id=_.find(FLAT_CATEGORY_OPTIONS,function(e){return-1==e.code().indexOf("-%")});else{var s=t.split("-")[0];DEFAULT_RECOMMENDATION.category_id=_.find(FLAT_CATEGORY_OPTIONS,function(e){return-1==e.code().indexOf("-%")&&e.code().split("-")[0]==s}).code()}delete r.id,mapping.fromJS(DEFAULT_RECOMMENDATION,r)}else mapping.fromJS(mapping.toJS(e),r);$("#"+n()+"-recommendation-modal",o.element).modal("show")},c=function(){$("#"+n()+"-recommendation-modal",o.element).modal("hide")},d=function(e){var t=ko.pureComputed({read:function(){return _.find(FLAT_CATEGORY_OPTIONS,function(t){return t.code()==e.category_id()})},write:function(t){e.category_id(t.code())}});ko.utils.extend(e,{categoryOptions:ko.observableArray(UNSELECTABLE_GROUP_CATEGORY_OPTIONS.slice(1)),selectedCategoryOption:t})};return ko.utils.extend(r,{setMode:function(e){return n(e),r},mode:n,saveButtonDisabled:ko.pureComputed(function(){return"create"==n()?!r.name()||!r.recommendation():_.isEqual(mapping.toJS(e),mapping.toJS(r))}),inProgress:ko.observable(!1),instanceList:a.instanceList,instanceIdProperty:a.instanceIdProperty,instanceLabelProperty:a.instanceLabelProperty,impactOptions:ko.observableArray(_.values(IMPACT)),severityOptions:ko.observableArray(_.values(SEVERITY)),statusOptions:ko.observableArray(_.values(STATUS)),dummyOptionCaption:ko.observable(null),showModal:s,closeModal:c}),d(r),r};return define("text!recommendation-configure-chart-modal-body.tmpl.html",function(){return configureChartModalTemplate}),define("text!recommendation-select-chart-modal-body.tmpl.html",function(){return selectChartModalTemplate}),{viewModel:{createViewModel:buildRecoComponentVM},template:recoComponentTemplate}});
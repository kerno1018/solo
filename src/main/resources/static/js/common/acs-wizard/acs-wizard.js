define(["jquery","knockout","resource-bundle","text!./acs-wizard.tmpl.html"],function(e,t,r,n){function s(r){var n=this;n.title="",n.wizardTitle=t.observable(""),n.wizardIcon=t.observable(""),n.steps=t.observable({}),n.currentStep=t.observable({}),n.subSteps=!1,n.currentStepIndex=0,n.currentStepSubLength=0,n.currentSubStepIndex=-1,n.exitButtonText=t.observable("Exit"),n.exitButtonCallback=null,n.enableExitButton=t.observable(!1),n.enableBackButton=t.observable(!0),n.showNextButton=t.observable(!0),n.enableNextButton=t.observable(!0),n.enableButton=t.observable(),n.nextButtonIcon=t.observable("fa-chevron-right fa pull-right"),n.nextButtonText=t.observable("Next"),n.stepSubTitle=t.observable(""),n.parentStep={},n.showWizardTrain=t.observable(!0),n.resultData=r.data,n.stepsKeys=t.observableArray([]),e.getJSON(r.meta,function(e){n.wizardIcon(e.titleIcon),n.title=e.title,n.parseSteps(e.steps),n.setCurrentStep(n.currentStepIndex)})}return s.prototype.getString=function(e){var t=r.getString(e);return t?t:e},s.prototype.loadSubStep=function(t){var r=this;r.subSteps=!0,e.isEmptyObject(r.parentStep)&&(r.parentStep=r.currentStep()),r.parentStep.subSteps()[t]&&(r.currentStep(r.parentStep.subSteps()[t]),r.loadStepVM())},s.prototype.gotoStep=function(e){var t=this;t.currentStep().stepState(""),t.currentStep().stepStateClass("fa-check fa"),t.setCurrentStep(e),t.resetSteps(e)},s.prototype.setCurrentStep=function(e,t){var r=this,e=parseInt(e);return r.steps()[e]?(r.currentStepIndex=e,r.currentStep(r.steps()[r.currentStepIndex]),-1===r.currentStep().stepState().indexOf("hidden")&&(r.currentStep().stepState("active"),r.currentStep().stepStateClass(" ")),r.showWizardTrain("showWizardTrain"in r.steps()[r.currentStepIndex]?r.steps()[r.currentStepIndex].showWizardTrain?!0:!1:!0),r.currentStepSubLength=r.currentStep().subSteps().length,t===!0?(r.currentSubStepIndex=r.currentStepSubLength-1,r.subSteps=!0,r.loadSubStep(r.currentSubStepIndex)):r.loadStepVM(),void 0):!1},s.prototype.resetSteps=function(e){for(var t=this,r=t.stepsKeys().length;r>e;r--)t.steps()[r].stepCompleted()===!1&&(-1===t.steps()[r].stepState().indexOf("hidden")?(t.steps()[r].stepState("disabled"),t.steps()[r].stepStateClass("")):(t.steps()[r].stepState("disabled hidden"),t.steps()[r].stepStateClass("")))},s.prototype.resetSubStep=function(){var e=this;e.parentStep={},e.subSteps=!1,e.currentStepSubLength=0,e.currentSubStepIndex=-1},s.prototype.exitWizard=function(){var e=this;e.resetSteps(e.stepsKeys()[0]),e.currentStep().exitButtonCallback&&e.currentVM[e.currentStep().exitButtonCallback]?e.currentVM[e.currentStep().exitButtonCallback]():(e.resetSubStep(),e.setCurrentStep(e.stepsKeys()[0]))},s.prototype.goBack=function(){for(var e,r,n,s=this,p=!1,u=s.currentStepIndex-1,S=s.currentStepIndex-1;S>=0;){var c=!1;if(s.steps()[S]&&s.steps()[S].skipStep&&s.currentVM[s.steps()[S].skipStep]&&(c=t.isObservable(s.currentVM[s.steps()[S].skipStep])?s.currentVM[s.steps()[S].skipStep]():s.currentVM[s.steps()[S].skipStep]),s.steps()[S]&&"function"==typeof s.steps()[S].skipSub&&s.steps()[S].skipSub.dispose(),s.steps()[S]&&c!==!0){u=s.steps()[S].stepID;break}S-=1}if(s.subSteps===!0&&(r=s.currentSubStepIndex,r>0))do r--,e=s.parentStep.subSteps()[r],n=t.isObservable(s.currentVM[e.skipStep])&&1==s.currentVM[e.skipStep]()||s.currentVM[e.skipStep]===!0,n&&(s.currentSubStepIndex=r);while(n&&r>0);s.currentStep().backButtonCallback&&s.currentVM[s.currentStep().backButtonCallback](),s.currentSubStepIndex-1===-1&&s.subSteps===!0&&(s.resetSubStep(),u=s.currentStepIndex,p=!0),s.subSteps===!0&&s.currentSubStepIndex-1>=0?(s.currentSubStepIndex=s.currentSubStepIndex-1,s.loadSubStep(s.currentSubStepIndex)):(s.currentStep(s.steps()[s.currentStepIndex]),s.currentStep().stepCompleted()===!0?(s.currentStep().stepState(" "),s.currentStep().stepStateClass("fa-check fa")):s.currentStep().stepState("disabled"),s.steps()[u]&&s.steps()[u].subSteps().length>0&&p===!1?s.setCurrentStep(u,!0):s.setCurrentStep(u))},s.prototype.goNext=function(){function e(){if(n.currentStepSubLength===n.currentSubStepIndex+1&&n.resetSubStep(),n.currentStepSubLength>0||n.subSteps===!0)n.currentSubStepIndex=n.currentSubStepIndex+1,n.subSteps=!0,n.loadSubStep(n.currentSubStepIndex);else{n.steps()[n.currentStepIndex]&&n.steps()[n.currentStepIndex].isStep===!0&&(n.currentStep(n.steps()[n.currentStepIndex]),t.isObservable(n.currentVM[n.currentStep().skipStep])&&1==n.currentVM[n.currentStep().skipStep]()||n.currentVM[n.currentStep().skipStep]===!0?(n.currentStep().stepState("disabled"),n.currentStep().stepStateClass("")):(t.isObservable(n.currentVM[n.currentStep().stepDisabled])&&n.currentVM[n.currentStep().stepDisabled]()?(n.currentStep().stepState(n.currentStep().stepState().replace("active","")),n.currentStep().stepState().trim()):n.currentStep().stepState(" "),n.currentStep().stepStateClass("fa-check fa")));for(var e=n.currentStepIndex+1;e<=n.stepsKeys().length;){var r=!1;if(n.steps()[e]&&n.steps()[e].skipStep&&n.currentVM[n.steps()[e].skipStep]&&(r=t.isObservable(n.currentVM[n.steps()[e].skipStep])?n.currentVM[n.steps()[e].skipStep]():n.currentVM[n.steps()[e].skipStep]),n.steps()[e]&&r!==!0){s=parseInt(n.steps()[e].stepID);break}e+=1}n.currentStep().stepCompleted(!0),n.setCurrentStep(s)}}var r,n=this,s=n.currentStepIndex+1;n.currentStep().nextButtonCallback&&(r=n.currentVM[n.currentStep().nextButtonCallback](n.resultData),"object"==typeof r&&r.done(function(){e()})),"object"==typeof r&&n.currentStep().nextButtonCallback||e()},s.prototype.loadStepVM=function(){function r(){p.nextButtonIcon(n("nextButtonIcon")),t.isObservable(p.currentVM[p.currentStep().nextButtonIcon])&&p.currentVM[p.currentStep().nextButtonIcon].subscribe(function(e){p.nextButtonIcon(e)}),p.nextButtonText(n("nextButtonText")),t.isObservable(p.currentVM[p.currentStep().nextButtonText])&&p.currentVM[p.currentStep().nextButtonText].subscribe(function(e){p.nextButtonText(e)}),t.isObservable(p.currentVM[p.currentStep().enableNextButton])&&p.currentVM[p.currentStep().enableNextButton].subscribe(function(e){p.enableNextButton(e)}),t.isObservable(p.currentVM[p.currentStep().enableBackButton])&&p.currentVM[p.currentStep().enableBackButton].subscribe(function(e){p.enableBackButton(e)}),t.isObservable(p.currentVM[p.currentStep().enableExitButton])&&p.currentVM[p.currentStep().enableExitButton].subscribe(function(e){p.enableExitButton(e)}),t.isObservable(p.currentVM[p.currentStep().showNextButton])&&p.currentVM[p.currentStep().showNextButton].subscribe(function(e,t){e===p.currentStep().stepID&&p.showNextButton(t)}.bind(p,p.currentStep().stepID)),t.isObservable(p.currentVM[p.currentStep().stepModified])&&p.currentVM[p.currentStep().stepModified].subscribe(function(e){if(e===!0)for(var t=parseInt(p.currentStep().stepID)+1;t<p.stepsKeys().length;t++)p.steps()[t].stepCompleted()===!0&&("function"==typeof p.steps()[t].skipSub&&p.steps()[t].skipSub.dispose(),p.steps()[t].stepState("disabled"),p.steps()[t].stepStateClass(""),p.steps()[t].stepCompleted(!1))}),t.isObservable(p.currentVM[p.wizardTitle])&&p.currentVM[p.wizardTitle].subscribe(function(e){p.wizardTitle(e)})}function n(e){return e in p.currentStep()?t.isObservable(p.currentVM[p.currentStep()[e]])?p.currentVM[p.currentStep()[e]]():p.currentStep()[e]:!0}function s(){p.currentStep().beforeRoutingAction&&p.currentVM[p.currentStep().beforeRoutingAction](p.resultData),window.setTimeout(function(){t.renderTemplate(p.currentStep().template,p.currentVM,{afterRender:function(){p.enableBackButton(n("enableBackButton")),p.enableNextButton(n("enableNextButton")),p.enableExitButton(n("enableExitButton")),p.showNextButton(n("showNextButton"));var e=p.getString(t.isObservable(p.currentVM[p.title])?p.currentVM[p.title]():p.currentVM[p.title]);p.wizardTitle(e),r(),p.currentStep().buttonsTemplate&&p.currentStep().btnTemplate(!0),p.currentStep().afterRenderAction&&p.currentVM[p.currentStep().afterRenderAction]()}},e("#stepTmpl")[0])},100)}var p=this;p.currentStep().viewModel&&require([p.currentStep().viewModel],function(e){p.currentVM=e;var r=!1;p.currentStep().skipStep&&(t.isObservable(p.currentVM[p.currentStep().skipStep])&&1==p.currentVM[p.currentStep().skipStep]()||p.currentVM[p.currentStep().skipStep]===!0)&&(r=!0,p.currentStep().stepID.indexOf(".")>=0?p.currentSubStepIndex===p.currentStepSubLength-1?(p.steps()[p.currentStepIndex].stepState("disabled"),p.steps()[p.currentStepIndex].stepStateClass(""),p.resetSubStep(),p.setCurrentStep(p.currentStepIndex+1)):(p.currentSubStepIndex=p.currentSubStepIndex+1,p.loadSubStep(p.currentSubStepIndex)):(-1===p.steps()[p.currentStepIndex].stepState().indexOf("hidden")&&p.steps()[p.currentStepIndex].stepState("disabled"),p.steps()[p.currentStepIndex].stepStateClass(""),p.setCurrentStep(p.currentStepIndex+1))),t.isObservable(p.currentVM[p.currentStep().skipStep])&&(p.steps()[p.currentStepIndex].skipSub=p.currentVM[p.currentStep().skipStep].subscribe(function(e,t){t===!0&&e===p.currentStep().stepID&&(p.currentStep().stepID.indexOf(".")>=0?p.currentSubStepIndex===p.currentStepSubLength-1?(p.steps()[p.currentStepIndex].stepState("disabled"),p.steps()[p.currentStepIndex].stepStateClass(""),p.resetSubStep(),p.setCurrentStep(p.currentStepIndex+1)):(p.currentSubStepIndex=p.currentSubStepIndex+1,p.loadSubStep(p.currentSubStepIndex)):(p.steps()[p.currentStepIndex].stepState("disabled"),p.steps()[p.currentStepIndex].stepStateClass(""),p.setCurrentStep(p.currentStepIndex+1)))}.bind(p,p.currentStep().stepID))),r===!1&&s()})},s.prototype.parseSteps=function(e){var r=this;e.sort(function(e,t){return parseFloat(e.stepID)-parseFloat(t.stepID)}),r.currentStepIndex=parseInt(e[0].stepID),e.forEach(function(e){var n=e.stepID&&e.stepID.split(".");if(e.stepState=t.observable("disabled"),e.stepStateClass=t.observable(""),e.btnTemplate=t.observable(!1),e.subSteps=t.observableArray([]),e.skipSub=null,e.showDropDown=e.showDropDown?e.showDropDown:!1,e.nextButtonIcon=e.nextButtonIcon?e.nextButtonIcon:"fa-chevron-right fa pull-right",e.stepCompleted=t.observable(!1),e.stepName=t.observable(e.stepName),require([e.viewModel],function(n){e.showStep&&n[e.showStep].subscribe(function(e,t){e.stepState(t?e.stepState().replace(" hidden",""):e.stepState()+" hidden")}.bind(r,e)),t.isObservable(n[e.stepName()])?(n[e.stepName()].subscribe(function(t){e.stepName(t)}),e.stepName(n[e.stepName()]())):e.stepName(r.getString(e.stepName())),e.stepDisabled&&t.isObservable(n[e.stepDisabled])&&n[e.stepDisabled].subscribe(function(e,t){e.stepState(t?e.stepState()+" disabled":e.stepState().replace(" disabled",""))}.bind(r,e))}),n.length>1){if(r.steps()[n[0]]){{r.steps()[n[0]]}r.steps()[n[0]].subSteps().push(e)}}else e.backButtonLabel=r.getString(e.backButtonLabel),e.nextButtonLabel=r.getString(e.nextButtonLabel),e.backButtonText=r.getString(e.backButtonText),e.nextButtonText=r.getString(e.nextButtonText),e.exitButtonText=e.exitButtonText?r.getString(e.exitButtonText):r.exitButtonText(),r.steps()[e.stepID]=e}),r.stepsKeys(Object.keys(r.steps()))},{viewModel:s,template:n}});
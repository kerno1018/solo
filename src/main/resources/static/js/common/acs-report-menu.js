define(["jquery","knockout","alert-utils","dialog-utils","acs-resource","jqueryui-amd/sortable"],function(e,a,t,s,i){var n=function(n){function l(e,t,s,i,n){var l=this;"true"===s?s=!0:"false"===s&&(s=!1),this.name=a.observable(e),this.template=a.observable(t?t:""),this.published=a.observable(s?s:!1),this.hidden=a.observable(!1),this.url=a.observable(o.getMenuItemUrl(t)),this.unpublished=a.computed(function(){return!this.published()},this),this.id="subitem_"+i,this.active=a.observable(n),this.name.subscribe(function(){o.enableSaveButton()}),this.template.subscribe(function(e){o.enableSaveButton(),l.url(o.getMenuItemUrl(e))}),this.published.subscribe(function(){o.enableSaveButton()})}function d(t,i,n,l,d,r,p){var u=this;this.name=a.observable(t),this.url=a.observable(l&&l.length>0?"javascript:;":o.getMenuItemUrl(i)),this.template=a.observable(i?i:""),this.active=a.observable(d),this.readOnly=a.observable(r?r:!1),this.order=p,l?(this.subpages=a.observableArray(l),this.subpageCount=l.length):(this.subpages=a.observableArray(),this.subpageCount=0),this.confirmDeleteSubPage=function(e){e.name().length>0?s.confirmationDialog("Are you sure you want to delete the sub page "+e.name()+" ?",u.deleteSubPage.bind(u,e),null,"Yes|No","Confirmation"):s.confirmationDialog("Are you sure you want to delete this sub page?",u.deleteSubPage.bind(u,e),null,"Yes|No","Confirmation")},this.deleteSubPage=function(e){u.subpages.remove(e),o.enableSaveButton()},"true"===n?n=!0:"false"===n&&(n=!1),this.published=a.observable(n),this.hidden=a.observable(!1),this.collapse=a.observable(!this.active()),this.unpublished=a.computed(function(){return!this.published()},this),this.publish=function(e){e.published(!0)},this.unpublish=function(e){e.published(!1)},this.handleMenuItemClick=function(){"javascript:;"==u.url()?(u.collapse()?(u.collapse(!1),e.each(o.pages(),function(e,a){a.name()!=u.name()&&a.collapse(!0)})):u.collapse(!0),u.active()?u.active(!1):(u.active(!0),e.each(o.pages(),function(e,a){a.name()!=u.name()&&a.active(!1)}))):window.location.href=u.url()},this.templates=o.templates,this.id="item_"+o.pageIndex,o.pageIndex++,this.name.subscribe(function(){o.enableSaveButton()}),this.template.subscribe(function(e){o.enableSaveButton(),u.url(o.getMenuItemUrl(e))}),this.readOnly.subscribe(function(){o.enableSaveButton()}),this.published.subscribe(function(){o.enableSaveButton()})}var o=this;if(o.saveButtonDisabled=a.observable(!0),o.pages=a.observableArray(),o.saved=!1,o.originalPages=a.observableArray(),o.pageIndex=0,o.id=n.id?n.id:null,o.saveInProgress=a.observable(!1),o.templates=[],o.templates.push({name:"- Select Template -",value:""}),o.fixedPages=a.observableArray(),o.filterValue=a.observable(""),o.detailsHidden=a.observable(!1),n.templates&&n.templates instanceof Array&&e.each(n.templates,function(e,a){o.templates.push(a)}),o.menuResource=new i({url:"reportmenu/menus",global:!1}),o.id){var r={id:o.id};n.instance_qualifier&&(r.base64Qualifiers=n.instance_qualifier),o.menuResource.get(r).done(function(a){var t=JSON.parse(a.definition),s=window.location.href,i=[],n=[],r=function(e,a){return e-a};e.each(t,function(a,t){var i,n,r=[];n=t.templateName.length>0?s.indexOf(t.templateName)>=0:!1,t.subItems&&e.each(t.subItems,function(e,a){var t;t=a.templateName.length>0?s.indexOf(a.templateName)>=0:!1,t&&(n=!0),r.push(new l(a.subItemName,a.templateName,a.published,e+1,t))}),i=new d(t.itemName,t.templateName,t.published,r,n,t.readOnly,t.order),t.fixedOnTop?o.fixedPages.push(i):o.pages.push(i)}),o.fixedPages().length>0&&(e.each(o.fixedPages(),function(e,a){n.push(a.order)}),n.sort(r),e.each(n,function(a,t){e.each(o.fixedPages(),function(e,a){a.order==t&&i.push(a)})}),o.fixedPages(i))})}return o.getMenuItemUrl=function(e){var a,t,s,i;return s=location.href,a=s.substring(0,s.indexOf("?")),a=a.substring(0,a.lastIndexOf("/")+1),t=s.substring(s.indexOf("?")),i=a+e+t},o.enableSaveButton=function(){o.saveButtonDisabled()&&(o.saveButtonDisabled(!1),e('span[data-rel-element="saveButton"]').tooltipster("disable"))},this.showManagePagesModal=function(){e("#manage-pages-modal").modal("show")},o.publish=function(e){e.published(!0)},o.unpublish=function(e){e.published(!1)},o.saveReportPages=function(){var a={},s=[];e.each(o.fixedPages(),function(a,t){var i={},n=[],l={};i.itemName=t.name(),i.templateName=t.template(),i.published=t.published(),i.description=t.description,i.order=t.order,i.fixedOnTop=!0,e.each(t.subpages(),function(e,a){l={},l.subItemName=a.name(),l.templateName=a.template(),l.published=a.published(),l.description=a.description,l.order=a.order,n.push(l)}),n.length>0&&(i.subItems=n),s.push(i)}),e.each(o.pages(),function(a,t){var i={},n=[],l={};i.itemName=t.name(),i.templateName=t.template(),i.published=t.published(),i.description="",i.order=a+1,e.each(t.subpages(),function(e,a){l={},l.subItemName=a.name(),l.templateName=a.template(),l.published=a.published(),l.description="",l.order=e+1,n.push(l)}),n.length>0&&(i.subItems=n),s.push(i)}),a.definition=JSON.stringify(s),o.saved=!0,o.saveInProgress(!0);var i;o.id?(a.id=o.id,i="/rest/reportmenu/menus/"+o.id,n.instance_qualifier&&(i+="?base64Qualifiers="+n.instance_qualifier),e.ajax({type:"PUT",url:i,data:JSON.stringify(a),contentType:"application/json",success:function(a,s,i){o.saveInProgress(!1),t.showSuccessAlert("Saved changes to report menu with id "+o.id),e("#manage-pages-modal").modal("hide")}})):(i="/rest/reportmenu/menus",e.ajax({type:"POST",url:i,data:JSON.stringify(a),contentType:"application/json",success:function(a,s,i){o.saveInProgress(!1),t.showSuccessAlert("Created new report menu with id "+a.id),o.id=a.id,e("#manage-pages-modal").modal("hide")}}))},o.createPage=function(){o.pages.unshift(new d("","",!0)),e(".row-action").tooltipster({position:"top",theme:"tooltipster-shadow"})},o.confirmDeletePage=function(e){e.name().length>0?s.confirmationDialog("Are you sure you want to delete the page "+e.name()+" ?",o.deletePage.bind(o,e),null,"Yes|No","Confirmation"):s.confirmationDialog("Are you sure you want to delete this page?",o.deletePage.bind(o,e),null,"Yes|No","Confirmation")},o.deletePage=function(e){o.pages.remove(e),o.enableSaveButton()},o.addSubPage=function(a){a.subpages().length+1;a.subpages.push(new l("","",!0,a.subpageCount)),a.subpageCount++,e(".row-action").tooltipster({position:"top",theme:"tooltipster-shadow"})},o.filterValue.subscribe(function(){var a=o.filterValue().toLowerCase().trim();if(0==a.length)e.each(o.pages(),function(a,t){t.hidden()&&t.hidden(!1),e.each(t.subpages(),function(e,a){a.hidden()&&a.hidden(!1)}),t.collapse(!t.active())}),e.each(o.fixedPages(),function(e,a){a.hidden()&&a.hidden(!1)}),o.detailsHidden(!1);else{e.each(o.fixedPages(),function(e,t){t.hidden(t.name().toLowerCase().indexOf(a)>=0?!1:!0)}),e.each(o.pages(),function(t,s){var i=!1,n=!1;s.name().toLowerCase().indexOf(a)>=0?(i=!0,e.each(s.subpages(),function(e,a){a.hidden(!1)})):(e.each(s.subpages(),function(e,t){t.name().toLowerCase().indexOf(a)>=0?(i=!0,n=!0,t.hidden(!1)):t.hidden(!0)}),s.collapse(!n)),s.hidden(i?!1:!0)});var t=!1;e.each(o.pages(),function(e,a){a.hidden()||(t=!0)}),o.detailsHidden(t?!1:!0)}}),o.afterRender=function(){e("#pages-container").sortable({cursor:"move",handle:".drag-icon",update:function(a,t){for(var s=e(this).sortable("toArray"),i=[],n=0;n<s.length;n++)for(var l=0;l<o.pages().length;l++)s[n]==o.pages()[l].id&&i.push(o.pages()[l]);o.pages(i)}}),e("#manage-pages-modal").on("show.bs.modal",function(){t.hideAlert(),e("#manage-pages-modal-alert-container .alert").length>0&&e("#manage-pages-modal-alert-container").empty(),e('span[data-rel-element="saveButton"]').tooltipster("enable"),o.saveButtonDisabled(!0),e(".row-action").tooltipster({position:"top",theme:"tooltipster-shadow"}),e(".drag-icon").tooltipster({position:"top",theme:"tooltipster-shadow"}),o.saved=!1,o.originalPages.removeAll(),e.each(o.pages(),function(a,t){var s=[];e.each(t.subpages(),function(e,a){s.push(new l(a.name(),a.template(),a.published(),e+1,a.active()))}),o.originalPages.push(new d(t.name(),t.template(),t.published(),s,t.active(),t.readOnly()))}),e("#pages-container").sortable({cursor:"move",containment:"parent",handle:".drag-icon",update:function(a,t){for(var s=e(this).sortable("toArray"),i=[],n=0;n<s.length;n++)for(var l=0;l<o.pages().length;l++)s[n]==o.pages()[l].id&&i.push(o.pages()[l]);o.pages(i),o.enableSaveButton()}}),e(".subpage-list").sortable({cursor:"move",update:function(a,t){var s=e(this).sortable("serialize"),i=(s.split("&"),[]),n=e(a.target).find(".subpage-row").attr("parentId"),l=null,d=e(this).sortable("toArray");if(e.each(o.pages(),function(e,a){a.id==n&&(l=a)}),null!=l){for(var r=0;r<d.length;r++)for(var p=0;p<l.subpages().length;p++)d[r]==l.subpages()[p].id&&i.push(l.subpages()[p]);l.subpages(i)}}})}),e("#manage-pages-modal").on("hidden.bs.modal",function(){o.saved||(o.pages.removeAll(),e.each(o.originalPages(),function(a,t){var s=[];e.each(t.subpages(),function(e,a){s.push(new l(a.name(),a.template(),a.published(),e+1,a.active()))}),o.pages.push(new d(t.name(),t.template(),t.published(),s,t.active(),t.readOnly()))}))})},{editLabel:"Edit",readOnly:"read_only"in n?n.read_only:!1,pages:this.pages,fixedPages:this.fixedPages,showManagePagesModal:this.showManagePagesModal,saveReportPages:this.saveReportPages,saveButtonDisabled:this.saveButtonDisabled,createPage:this.createPage,afterRender:this.afterRender,templates:this.templates,addSubPage:this.addSubPage,publish:this.publish,unpublish:this.unpublish,confirmDeleteSubPage:this.confirmDeleteSubPage,confirmDeletePage:this.confirmDeletePage,saveInProgress:this.saveInProgress,filterValue:o.filterValue,enableFiltering:"enable_filtering"in n?n.enable_filtering:!0,detailsHidden:o.detailsHidden}};return{viewModel:{createViewModel:n},template:'<nav class="bs-docs-sidebar" id="leftCol">                 <input type="text" style="width: 80%; margin-bottom: 12px" placeholder="Menu Filter" data-bind="css: {hidden: enableFiltering == false}, value: filterValue, valueUpdate:[\'afterkeydown\']">                 <ul class="nav nav-stacked nav-side affix-top" id="sidebar">                     <h data-bind="foreach: fixedPages">                         <li data-bind="css: {active: active, hidden: hidden()}">                             <a data-bind="text: name, attr: {href: url, name: name}"></a>                         </li>                     </h>                     <li data-bind="if: fixedPages().length > 0"><div class="separator-middle"></div></li>                     <li>                         <span class="nav-header" data-bind="css: {hidden: detailsHidden}">Details</span>                             <span class="field-action">                                 <a href="javascript:;" data-bind="click: showManagePagesModal, css: {hidden: readOnly}">                                     <span class="fa-pencil fa left"></span>                                     <span data-bind="text: editLabel"></span>                                     <span class="sidebar-child"></span>                                 </a>                             </span>                              <ul class="in" data-bind="foreach: pages">                                <li data-bind="css: {active: active || hidden() == false}">                                     <a data-bind="attr: {href: url, name: name}, css: {hidden: published() == false || hidden()}, click: handleMenuItemClick">                                         <span data-bind="text: name"></span>                                         <!-- ko if:subpages().length > 0 -->                                            <span class="sidebar-child"></span>                                         <!-- /ko -->                                     </a>                                     <!-- ko if:subpages().length > 0 -->                                         <ul class="in" data-bind="foreach: subpages, css: {collapse: collapse()}">                                             <li data-bind="css: {active: active}">                                                <a data-bind="text: name, css: {hidden: published() == false || hidden()}, attr: {href: url, name: name}"></a>                                             </li>                                         </ul>                                    <!-- /ko -->                                </li>                              </ul>                     </li>                 </ul>             </nav>             <span data-bind="template: { afterRender: afterRender }"></span>             <div class="modal" tabindex="-1" role="dialog" aria-labelledby="srcModalLabel" aria-hidden="true" id="manage-pages-modal">                 <div class="vertical-alignment-helper">                     <div class="modal-dialog vertical-align-center modal-lg">                         <div class="modal-content">                             <div class="modal-header">                                 <div class="main-title">                                     <div class="fa-gear icon"></div>                                     <h1>Manage Pages</h1>                                     <h2>Manage report pages below</h2>                                     <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>                                 </div>                             </div>                             <div id="manage-pages-modal-alert-container">                             </div>                             <div class="modal-body">                                 <div class="scroll400">                                     <div>                                         <div class="float-right">                                             <acs-sec-button params="label: \'Create Page\',                                                                 click_action: createPage,                                                                 btn_type: \'button\',                                                                 icon_class: \'fa fa-plus left\',                                                                 id: \'create-page-button\'">                                             </acs-button>                                         </div>                                     </div>                                     <div class="builder-menu" data-bind="foreach: fixedPages" style="clear: both">                                         <div class="panel panel-default">                                                 <div class="panel-body">                                                     <span data-bind="text: name"></span>                                                 </div>                                         </div>                                     </div>                                     <div class="builder-menu" data-bind="foreach: pages" id="pages-container" style="clear: both">                                         <div data-bind="attr: {id: id}">                                             <div class="panel panel-default" data-bind="css: {\'bdr-gray-lightest\': published() == false, sortable: readOnly() == false}">                                                 <div class="panel-body">                                                     <span data-bind="css: {\'txt-gray-lighter\': published() == false, disabled: readOnly, \'drag-icon\': readOnly() == false}" class="fa-bars fa icon" style="cursor: move; margin-right: 6px" title="Drag to Reorder"></span>                                                     <!-- ko if:readOnly() == false -->                                                     <input type="text" data-bind="value: name, valueUpdate:[\'afterkeydown\']" style="display: inline-block; width: 200px" placeholder="Enter Category Name"/>                                                     <!-- /ko -->                                                     <!-- ko if:readOnly() -->                                                     <div data-bind="text: name" style="display: inline-block; width: 150px"></div>                                                     <!-- /ko -->                                                     <!-- ko if:readOnly() == false -->                                                         <!-- ko if:template().length == 0 -->                                                             <select data-bind="value: template, options: $parent.templates, optionsText: \'name\', optionsValue: \'value\'" style="display: inline-block; width: 160px; margin-left: 10px">                                                         </select>                                                         <!-- /ko -->                                                         <!-- ko if:template().length > 0 -->                                                             <span data-bind="text: template, css: {disabled: unpublished}" style="margin-left: 20px"></span>                                                         <!-- /ko -->                                                     <!-- /ko -->                                                     <!-- ko if:readOnly() -->                                                         <span data-bind="text: template, css: {disabled: unpublished}" style="margin-left: 20px"></span>                                                     <!-- /ko -->                                                     <div class="float-right">                                                         <div class="row-actions">                                                             <a href="javascript:;" class="row-action tooltipstered" title="Add Sub Page" data-bind="click: $parent.addSubPage, css: {disabled: readOnly}">                                                                 <span class="fa fa-plus"></span>                                                             </a>                                                             <span data-bind="if: published">                                                                 <a href="javascript:;" class="row-action tooltipstered" title="Unpublish" data-bind="click: $parent.unpublish, css: {disabled: readOnly}">                                                                     <span class="fa fa-eye-slash"></span>                                                                 </a>                                                             </span>                                                             <span data-bind="ifnot: published">                                                                 <a href="javascript:;" class="row-action tooltipstered" title="Publish" data-bind="click: $parent.publish, css: {disabled: readOnly}">                                                                     <span class="fa fa-eye"></span>                                                                 </a>                                                             </span>                                                             <a href="javascript:;" class="row-action tooltipstered" title="Delete" data-bind="click: $parent.confirmDeletePage, css: {disabled: readOnly}">                                                                 <span class="fa fa-remove"></span>                                                             </a>                                                         </div>                                                     </div>                                                 </div>                                             </div>                                             <div class="subpage-list" data-bind="foreach: subpages" data-bind="attr: {parentId: $parent.id}">                                                 <div class="subpage-row panel panel-default builder-menu" style="margin-left: 25px" data-bind="attr: {id: id, parentId: $parent.id}, css: {\'bdr-gray-lightest\': published() == false}">                                                     <div class="panel-body">                                                         <span data-bind="css: {\'txt-gray-lighter\': published() == false}" class="fa-bars fa icon drag-icon" style="cursor: move; margin-right: 6px" title="Drag to Reorder"></span>                                                         <input type="text" data-bind="value: name, valueUpdate:[\'afterkeydown\']" style="display: inline-block; width: 200px" placeholder="Enter Category Name"/>                                                             <!-- ko if:template().length == 0 -->                                                                 <select data-bind="value: template, options: $parent.templates, optionsText: \'name\', optionsValue: \'value\'" style="display: inline-block; width: 160px; margin-left: 10px">                                                                 </select>                                                             <!-- /ko -->                                                             <!-- ko if:template().length > 0 -->                                                                 <span data-bind="text: template, css: {disabled: unpublished}" style="margin-left: 20px"></span>                                                             <!-- /ko -->                                                         <div class="float-right">                                                             <div class="row-actions">                                                                 <a href="javascript:;" class="disabled tooltipstered" title="Add Sub Page">                                                                     <span class="fa fa-plus"></span>                                                                 </a>                                                                 <span data-bind="if: published">                                                                     <a href="javascript:;" class="row-action tooltipstered" title="Unpublish" data-bind="click: $parent.unpublish">                                                                         <span class="fa fa-eye-slash"></span>                                                                     </a>                                                                 </span>                                                                 <span data-bind="ifnot: published">                                                                     <a href="javascript:;" class="row-action tooltipstered" title="Publish" data-bind="click: $parent.publish">                                                                         <span class="fa fa-eye"></span>                                                                     </a>                                                                 </span>                                                                 <a href="javascript:;" class="row-action tooltipstered" title="Delete" data-bind="click: $parent.confirmDeleteSubPage">                                                                     <span class="fa fa-remove"></span>                                                                 </a>                                                             </div>                                                         </div>                                                     </div>                                                 </div>                                             </div>                                         </div>                                     </div>                                 </div>                             </div>                             <div class="modal-footer">                                 <div class="button-con">                                     <div class="float-right">                                         <acs-button params="label: \'Save\',                                             title:\'Disabled, make changes to enable\',                                             icon_class: \'fa fa-check left\',                                             id: \'saveButton\',                                             action: saveReportPages,                                             loading: saveInProgress,                                             disabled: saveButtonDisabled"                                         ></acs-button>                                         <a data-dismiss="modal" href="javascript:;">Cancel</a>                                     </div>                                  </div>                             </div>                         </div>                     </div>                 </div>             </div>'}});
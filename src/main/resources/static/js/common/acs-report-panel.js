define(["jquery","knockout","signal-emitter","modal-utils","dialog-utils","jqueryui-amd/draggable","jqueryui-amd/sortable"],function(e,n,t,a,o){var i=function(a,i){var s,r=n.observable(),l=n.contextFor(i.element).$data,d=n.isObservable(a.title)?a.title:n.observable(a.title),c=n.observable(0),m=n.observableArray([{id:"1",name:"Chart",description:"Chart",iconClass:"fa fa-area-chart",componentHtml:"<acs-chart-container params='chart_name: \"__NO_CHART_SET__\",\r\n                        instance_qualifier: $report_instance_id,\r\n                        show_customization: showCustomization,\r\n                        visible: true,\r\n                        bind_variable: {}'></acs-chart-container>"},{id:"2",name:"Table",description:"Table",iconClass:"fa fa-table",componentHtml:'<acs-chart-container params=\'chart_name: "__NO_CHART_SET__",\r\n                        type: "Table",\r\n                        instance_qualifier: $report_instance_id,\r\n                        show_customization: showCustomization,\r\n                        visible: true,\r\n                        bind_variable: {}\'></acs-chart-container>'},{id:"3",name:"Text",description:"Text",iconClass:"fa fa-edit",componentHtml:"<acs-report-text \r\n                    params=\"editable: true, customizationEnabled: showCustomization, \r\n                    broadcast_change: true, placeholder: 'To change this text content, click the Edit link at the end of this text'\">\r\n                    </acs-report-text>"},{id:"4",name:"Title",description:"Title",iconClass:"fa fa-star",componentHtml:"<acs-report-title-text \r\n                    params=\"customizationEnabled: showCustomization, \r\n                    broadcast_change: true, placeholder: 'New Title' \">\r\n                    </acs-report-title-text>"},{id:"5",name:"Recommendation",description:"Recommendation",iconClass:"fa fa-wrench",componentHtml:'<acs-report-recommendation \r\n                        params="customizationEnabled: showCustomization, category: templateName">\r\n                        </acs-report-recommendation>'},{id:"6",name:"Divider",description:"Divider",iconClass:"fa fa-ellipsis-h",componentHtml:'<hr class="line-dotted margin-top-15 margin-bottom-15"/>'}]);n.components.isRegistered("acs-oracheck-container")&&m.push({id:"7",name:"Orachk",description:"Component to show the Orachk results for an input",iconClass:"fa fa-stethoscope",componentHtml:'<acs-oracheck-container \r\n                        params="showCustomization: showCustomization">\r\n                        </acs-oracheck-container>'});var p=function(){return Math.floor(1e8*Math.random())},h=function(a,o){for(var r,l=0;l<m().length;l++)if(m()[l].id==a){r=m()[l].componentHtml;break}var d=e(r);d.attr("id",p());var h=z(e(".sortable",i.element).children.length-1,d),u=0;if(o){var v=g(o);e(".sortable",i.element).children().each(function(e,n){n==v&&(u=e)}),h.insertAfter(v)}else e(".sortable",i.element).append(h),u=0;t.dispatch("Report-Component-InsertedAfter",[i.element,u,d[0].outerHTML]),c(k()),n.applyBindings(s,h[0]);var f=d.parents(".sortable").children(".component");_(f),C()},u=function(e){t.dispatch("Report-Component-Duplicated",[i.element,e]),c(k())},v=function(n){var a=e("#"+n,i.element);t.dispatch("Report-Component-Param-Toggled",[a,"visible",!1]),c(k())},f=function(n){o.confirmationDialog("Are you sure to delete this component?",function(){var a;e(".sortable",i.element).children().each(function(t,o){e(o).find("#"+n).length>0&&(a=o)}),t.dispatch("Report-Component-Removed",[i.element,n]),a&&e(a).remove(),c(k()),C()})},b=function(e){t.dispatch("Report-Component-Reordered",[i.element,e])},C=function(){e.each(e(".component",i.element),function(n,t){e(t).attr("id",n+1)})},w=function(n,t){var a=e("#"+n,i.element).parents(".component");if(t){var o=a.next();o.insertBefore(a).hide().fadeIn("slow")}else{var o=a.prev();o.insertAfter(a).hide().fadeIn("slow")}e("html, body").animate({scrollTop:a.offset().top},1e3);var s=e(".component",i.element),r=[];e.each(s,function(n,t){r.push(e(t).attr("id")),e(t).attr("id",n+1)}),console.log(r),b(r);var l=e("#"+n,i.element).parents(".sortable").children(".component");_(l)},_=function(n){e.each(n,function(t,a){e(a).find("._moveup_").removeClass("disabled"),e(a).find("._movedown_").removeClass("disabled"),0==t&&e(a).find("._moveup_").addClass("disabled"),t==n.length-1&&e(a).find("._movedown_").addClass("disabled")})};d.subscribe(function(e){t.dispatch("Report-Component-Param-Changed",[i.element,"title",e])}),t.addListener("Report-Template-Node-Inserted:"+i.element.id,function(t,a,o){var r;e(".sortable",i.element).children().each(function(n,t){e(t).find("#"+a).length>0&&(r=t)});var l=z(e(".sortable",i.element).children().length-1,e(o));r?l.insertAfter(r):e(".sortable",i.element).append(l),n.applyBindings(s,l[0]),C()},this);var g=function(n){var t;return e(".sortable",i.element).children().each(function(a,o){e(o).find("#"+n).length>0&&(t=o)}),t},z=function(n,t){for(var a=t.id?t.id:t.attr("id"),o=e('<section class="handle component" id="'+n+'">\r\n                                        <div class="builder-top" data-bind="visible: showCustomization">\r\n                                            <a class="_remove_ builder_tooltips" href="javascript:void(0)" title="Remove this component"><span class="fa fa-close" data-bind="visible: showCustomization, click: function(){removeComponent(\''+a+'\')}"></span><em class="hidden">Remove</em></a>\r\n                                            <a class="_copy_ builder_tooltips" href="javascript:void(0)" title="Duplicate this component"><span class="fa fa-copy" data-bind="visible: showCustomization, click: function(){copyComponent(\''+a+'\')}"></span><em class="hidden">Clone</em></a>\r\n                                            <a class="_toggle_ builder_tooltips" href="javascript:void(0)" title="Show or hide" data-bind="click: function(){toggleComponent(\''+a+'\')}, visible: showCustomization"><span class="fa fa-eye-slash"></span><em class="hidden">Hide</em></a>\r\n                                            <a class="_moveup_ builder_tooltips" href="javascript:void(0)" title="Move Up" data-bind="event: {click: function() {moveUpDown(\''+a+"',"+!1+')}}, visible: showCustomization"><span class="fa-arrow-circle-up fa tipster"></span><em class="hidden">Move Up</em></a>\r\n                                            <a class="_movedown_ builder_tooltips" href="javascript:void(0)" title="Move Down" data-bind="event: {click: function() {moveUpDown(\''+a+"',"+!0+')}}, visible: showCustomization"><span class="fa-arrow-circle-down fa tipster"></span><em class="hidden">Move Down</em></a>\r\n                                        </div>\r\n                                     </section>'),i='<div class="builder-bottom" data-bind="visible: showCustomization">\r\n                                        <div class="dropdown">\r\n                                            <a href="javascript:void(0)" class="add-below tipster" data-toggle="dropdown" aria-label="Add" title="Add">\r\n                                                <span class="fa-plus fa"></span>\r\n                                            </a>\r\n                                            <ul class="dropdown-menu tooltipster-drop-down big-dropdown">',s=0;s<m().length;s++)i+='<li><a href="javascript:void(0)" data-bind="click: function(){insertComponent('+m()[s].id+",'"+a+'\')}"><span class="'+m()[s].iconClass+'"></span>'+m()[s].name+"</a></li>";return i+="</ul></div><hr></div>",o.append(e("<div data-bind=\"css: showCustomization() ? 'panel panel-default panel-body' : ''\"></div>").append(t)).append(i),o};e.each(i.templateNodes,function(e){this instanceof HTMLElement&&(c(c()+1),i.templateNodes[e]=z(c(),this).get(0))}),window.setTimeout(function(){var n=e(".sortable",i.element).children(".component");_(n)},4e3);var k=function(){var n=0;return e(".sortable",i.element).children().each(function(t,a){"0"!=e(a).attr("id")&&1==e(a).is(":visible")&&n++}),n},y=function(){var n=e(".sortable",i.element).children(".component");_(n)};return s=e.extend({title:d,visible:"undefined"==typeof a.visible?!0:a.visible,availableComponents:m,selectedComponent:r,showCustomization:"undefined"==typeof l.customizationEnabled?!1:l.customizationEnabled,insertComponent:h,removeComponent:f,childrenCount:c,moveUpDown:w,copyComponent:u,toggleComponent:v,afterRender:y,templateName:l.templateDetails.name},l)};return{viewModel:{createViewModel:i},template:'<section data-bind="css: showCustomization() ? \'builder\' : \'builder-read\', style: {border: showCustomization() ? \'1px dashed #d6dfe6\' : \'0px\', }, visible: (visible & ((childrenCount() > 0 && !showCustomization()) || showCustomization())) ">\r\n                            <div class="sortable">\r\n                                <div class="panel panel-default" data-bind="visible: (showCustomization() && childrenCount() == 0)" id="0">\r\n                                    <div class="panel-body">\r\n                                        <div class="builder-bar">\r\n                                            <!-- ko foreach: availableComponents -->\r\n                                                <a href="javascript:void(0)" data-bind="click: function(){$parent.insertComponent($data.id)}"><i data-bind="css: $data.iconClass"></i><span data-bind="text: $data.name"></span></a>\r\n                                            <!-- /ko -->\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                                <!-- ko template: { nodes: $componentTemplateNodes, data: $data } --><!-- /ko -->\r\n                            </div>\r\n                       </div>\r\n                    </section>'}});
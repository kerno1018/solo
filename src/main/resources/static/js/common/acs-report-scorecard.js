define(["jquery","knockout","acs-resource"],function(e,t,a){var i=function(i){function n(e,a,i,n,o){this.url=window.location.href.replace("Scorecard","Recommendations")+"&category_id="+e+"-%25",this.categoryName=e,this.categoryName=this.categoryName.replace(/_/g," "),this.criticalCount=i,this.warningCount=n,this.infoCount=o,this.instance=a,this.hidden=t.observable(!1)}var o=this;return o.categoryCountMap={},o.recommendationsList=t.observableArray(),o.listViewSelected=t.observable(!0),o.tileViewSelected=t.observable(!1),o.targetNameList=t.observableArray(),o.targetNameList.push("All Instances"),o.selectedInstanceFilter=t.observable("All Instances"),o.selectedInstanceDisplayName=t.observable("All Instances"),o.MAX_LENGTH_SELECTED_INSTANCE_NAME=13,o.datatableReference=t.observable(),o.numVisibleRecommendations=t.computed(function(){var t=0;return e.each(o.recommendationsList(),function(e,a){a.hidden()||t++}),t},this),o.selectInstance=function(e){o.selectedInstanceFilter(e)},o.selectedInstanceFilter.subscribe(function(t){o.datatableReference&&("All Instances"==t?(o.datatableReference().column("1").search("").draw(),o.selectedInstanceDisplayName(t),e.each(o.recommendationsList(),function(e,t){t.hidden(!1)})):(o.datatableReference().column("1").search(t,!0).draw(),o.selectedInstanceDisplayName(t.length>o.MAX_LENGTH_SELECTED_INSTANCE_NAME?t.substr(t,o.MAX_LENGTH_SELECTED_INSTANCE_NAME)+"...":t),e.each(o.recommendationsList(),function(e,a){a.hidden(a.instance==t?!1:!0)})))}),o.recommendationTableOptions={order:[[0,"asc"]],lengthMenu:[25,50,100]},this.init=function(){o.allCategories=[],o.categories=[],e.getJSON(window.__MODULE_PREFIX__("assets","js/common/resources/recommendation_categories.json"),function(e){for(var t in e)"All Categories"!=t&&"Category Level1"!=t&&o.allCategories.push(t)});var s=new a({url:"recommendations/property",global:!1}),r={k:"assessment_id",v:t.unwrap(i.assessment_id)},c=function(e,t){var a;return a=o.categoryCountMap[e][t]&&o.categoryCountMap[e][t].count?o.categoryCountMap[e][t].count:0};s.get(r).done(function(t){e.each(t,function(e,t){if(t.props&&t.props.category_id){var a=t.props.category_id,i=a.split("-"),n=i[0],s=t.severity,r=t.props.target_name;o.categoryCountMap[n]?o.categoryCountMap[n][s]?o.categoryCountMap[n][s].count++:(o.categoryCountMap[n][s]={},o.categoryCountMap[n][s].count=1):(o.categoryCountMap[n]={},o.categoryCountMap[n][s]={},o.categoryCountMap[n][s].count=1),r&&(-1==o.targetNameList().indexOf(r)&&o.targetNameList.push(r),o.categoryCountMap[n].target_name=r,o.categoryCountMap[n][s].target_name=r)}});for(var a in o.categoryCountMap){var i,s=c(a,"Critical"),r=c(a,"Warning"),l=c(a,"Info");i=o.categoryCountMap[a].target_name?o.categoryCountMap[a].target_name:"N/A",o.categories.push(a.replace(/_/g," ")),o.recommendationsList.push(new n(a,i,s,r,l))}e.each(o.allCategories,function(e,t){-1==o.categories.indexOf(t)&&o.recommendationsList.push(new n(t,"N/A",0,0,0))});var d=o.recommendationsList().sort(function(e,t){return e.categoryName.localeCompare(t.categoryName)});o.recommendationsList(d),e(".tipster").tooltipster({position:"top",theme:"tooltipster-shadow",maxWidth:1e3})})},this.afterRender=function(){o.init();var t='<tr><th style="border-bottom: 1px solid #ffffff !important"></th><th style="border-bottom: 1px solid #ffffff !important"></th><th colspan="3" style=""border-bottom: 1px solid #d1d1d1 !important"><div class="text-center">Recommendation Severity</div></th></tr>',a='<div class="btn-group" role="group"><button id="list-view-icon" type="button" class="btn btn-default tipster" title="List View"><span class="fa fa-list"></span></button><button id="tile-view-icon" type="button" class="btn btn-default tipster" title="Tile View"><span class="fa fa-th-large"></span></button></div>',i=e(t),n=e("#acs-report-scorecard-table-container .table-actions .float-right"),s=e("#acs-report-scorecard-table-container .buttons-collection");s.addClass("hidden"),e("#report-scorecard-table thead").prepend(i),n.append(e(a)),e("#acs-report-scorecard-table-container .table-actions").css("margin-bottom","10px"),e("#acs-report-scorecard-table-container .table-footer").addClass("hidden"),e("#tile-view-icon").on("click",function(){e("#report-scorecard-table").addClass("hidden"),e("#acs-report-scorecard-table-container .table-footer").addClass("hidden"),e("#acs-report-scorecard-tile-view-container").removeClass("hidden"),e("#list-view-icon").removeClass("active"),e("#tile-view-icon").addClass("active"),o.tileViewSelected(!0),o.listViewSelected(!1)}),e("#list-view-icon").on("click",function(){e("#report-scorecard-table").removeClass("hidden"),e("#acs-report-scorecard-table-container .table-footer").removeClass("hidden"),e("#acs-report-scorecard-tile-view-container").addClass("hidden"),e("#list-view-icon").addClass("active"),e("#tile-view-icon").removeClass("active"),o.tileViewSelected(!1),o.listViewSelected(!0)}),e(".tipster").tooltipster({position:"top",theme:"tooltipster-shadow",maxWidth:1e3}),e("#acs-report-scorecard-table-container input").on("keyup",function(){var t=e("#acs-report-scorecard-table-container table tbody tr");e.each(o.recommendationsList(),function(e,t){t.hidden(!0)}),e.each(t,function(t,a){var i,n=e(a),s=n.find("td");s.length>0&&(i=e(s[0]).html(),e.each(o.recommendationsList(),function(e,t){t.categoryName==i&&t.hidden(!1)}))})})},{afterRender:this.afterRender,listViewSelected:this.listViewSelected,tileViewSelected:this.tileViewSelected,recommendationTableOptions:this.recommendationTableOptions,recommendationsList:this.recommendationsList,targetNameList:o.targetNameList,selectedInstanceFilter:o.selectedInstanceFilter,datatableReference:o.datatableReference,selectedInstanceDisplayName:o.selectedInstanceDisplayName,selectInstance:o.selectInstance,numVisibleRecommendations:o.numVisibleRecommendations}};return{viewModel:{createViewModel:i},template:'<div class="dropdown float-right">                <a class="btn buttons-collection btn-default" tabindex="0" href="javascript:void(0)" id="instance-filter-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="margin-right: 0px">                    <span></span><span class="fa fa-gear float-left"></span><span data-bind="text: selectedInstanceDisplayName"></span>                </a>                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="instance-filter-button" data-bind="foreach: targetNameList" style="top: 28px; padding: 10px 10px">                    <li>                        <input type="radio" data-bind="checked: $parent.selectedInstanceFilter, attr: {value: $data}"><span class="btn-link" data-bind="text: $data, click: $parent.selectInstance" style="position: relative; top: -3px; cursor: pointer"></span>                    </li>                </ul>            </div>            <div class="clearfix"></div>            <div id="acs-report-scorecard-table-container">                <table id="report-scorecard-table" class="hidden table dataTable" data-bind="dataTable: {datatableRef: datatableReference, data: recommendationsList, options: recommendationTableOptions}">                <col data="categoryName" title="Category" targets=0 width="47%">                <col data="instance" title="Instance" targets=1 width="25%">                <col data="criticalCount" title="Critical" targets=2 width="10%" template="<div style=\'position: relative; left: 25px\' col-data-bind=\'text: criticalCount\'></div>">                <col data="warningCount" title="Warning" targets=3 width="10%" template="<div style=\'position: relative; left: 32px\' col-data-bind=\'text: warningCount\'></div>">                <col data="infoCount" title="Info" targets=4 width="8%" template="<div style=\'position: relative; left: 12px\' col-data-bind=\'text: infoCount\'></div>">                </table>            </div>            <div id="acs-report-scorecard-tile-view-container">                <div data-bind="if: numVisibleRecommendations() == 0">                    <div class="text-center">No matching records found</div>                </div>                <div class="tiles-list">                    <ul class="nav nav-tabs" data-bind="foreach: recommendationsList" >						<li class="col-md-3 col-sm-4 col-xs-3 no-padding" data-bind="css: {hidden: hidden}">							<div class="tile">								<a class="tile-header bg-gray-lightest text-center" data-bind="attr: {href: url}">									<h3 data-bind="text: categoryName">Database Time</h3>								</a>								<div class="tile-body text-center">									<div class="circle-maker small bg-red tipster" title="Critical" data-bind="text: criticalCount">									</div>									<div class="circle-maker small bg-orange tipster" title="Warning" data-bind="text: warningCount">									</div>									<div class="circle-maker small bg-blue tipster" title="Info" data-bind="text: infoCount">									</div>								</div>							</div>						</li>                    </ul>                </div>            </div>            <span data-bind="template: { afterRender: afterRender }"></span>'}});